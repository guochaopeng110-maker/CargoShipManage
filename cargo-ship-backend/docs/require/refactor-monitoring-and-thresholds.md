# 提案：重构监控与告警模型以支持业务特定的监测点

**负责人:** @你的名字
**审批人:** @审批人名字
**日期:** 2025年12月5日
**状态:** 提案中

## 1. 概述

本提案旨在对项目核心的监控与告警数据模型进行一次全面的重构，以准确地实现客户提供的最新、更详细的监控需求。现有的数据模型在区分具体业务监测点、存储告警规则的完整信息方面存在严重的设计缺陷，本次重构将彻底解决这些问题。

## 2. 背景与问题陈述

通过对客户提供的需求文档（详见 `docs/data/`）进行深入分析，我们发现当前数据库的模式与业务需求之间存在以下几个关键的不匹配点：

1.  **监测点定义模糊：** 当前系统仅使用一个通用的 `metricType`（指标类型，如 `voltage`）来标识时序数据。然而，业务需求需要明确区分共享相同物理类型但业务含义不同的监测点（例如，“总电压” vs “单体电压”）。这种模糊性使得我们无法为特定的业务监测点配置告警，也无法精确地查询其数据。

2.  **告警规则信息不完整：** `threshold_configs`（阈值配置）表目前只能定义数值阈值，但缺少存储关键业务上下文的字段，例如与规则关联的 **“故障名称”**（如“总压过压”）以及触发告警后应采取的 **“处理措施”**。

3.  **设备数据粒度错误：** `equipment` 表中现有的种子数据过于细化（例如“1#电池组”）。而业务需求是需要在更高的“设备系统”层面（例如“电池装置系统”）进行管理。

本次重构对于准确映射客户的业务逻辑、确保数据的完整性和实现精确的监控、告警与报告功能至关重要。

## 3. 提议的解决方案

我们将采用一个“自底向上”的全面重构计划，该计划覆盖了数据库结构、应用层逻辑和现有数据。

### 第 1 步：增强核心数据库结构

我们将对数据库模式进行扩展，以支持“监测点”、“故障名称”和“处理措施”这些新的业务概念。

1.  **修改 `threshold_configs` 表：**
    -   增加 `monitoring_point` (varchar) 列：用于存储业务定义的、唯一的监测点名称（例如“总电压”）。
    -   增加 `fault_name` (varchar) 列：用于存储与此规则关联的特定故障名称（例如“总压过压”）。
    -   增加 `recommended_action` (varchar) 列：用于存储触发告警时应采取的纠正措施。

2.  **修改 `time_series_data` 表：**
    -   增加 `monitoring_point` (varchar) 列：此列将每一条时序数据都关联到一个特定的业务监测点，从而解决了单独使用 `metricType` 时的模糊性问题。

3.  **实施细节：**
    -   同步更新相应的实体文件 (`threshold-config.entity.ts`, `time-series-data.entity.ts`)。
    -   创建一个新的数据库迁移文件，以原子方式应用上述所有数据库结构变更。

### 第 2 步：适配应用层逻辑和DTO

所有与已修改的表进行交互的应用代码都将进行更新，以与新的数据库模式保持一致。

1.  **DTOs (数据传输对象)：** `monitoring` 和 `alarm` 模块中的DTO将被更新，以便在创建、更新和查询操作中包含新的 `monitoring_point`、`fault_name` 和 `recommended_action` 字段。

2.  **Services (服务层)：**
    -   **`ThresholdService` & `MonitoringService`:** 更新逻辑，以正确地处理、验证和查询使用新 `monitoring_point` 字段的数据。
    -   **`AlarmService`:** 重构告警触发的核心逻辑，使其能够基于 `equipment_id` 和 `monitoring_point` 的组合来精确匹配规则。
    -   **`QueryService` & `ExportService`:** 增强统计和数据导出功能，以支持按 `monitoring_point` 进行聚合和筛选。

### 第 3 步：修正并填充数据

我们将清理不正确的种子数据，并使用新的、准确的监控规则来填充数据库。

1.  **修正设备数据：** 创建一个新的数据库迁移文件，用于删除旧的、粒度过细的设备记录，并插入正确的“设备系统”级别的设备记录。

2.  **更新测试数据：** 现有的 `1732400000000-SeedTestData.ts` 迁移文件将被完全重写，以生成与新模式兼容的测试数据，包括为 `monitoring_point` 和其他新字段提供有效值。

3.  **自动化规则填充：** 创建一个独立的脚本 (`scripts/seed-customer-rules.ts`)，用于解析 `docs/data/` 中的客户文档，并自动将所有监控规则填充到 `threshold_configs` 表中。

## 4. 理由与益处

-   **准确性：** 新的数据模型与“监测点”的业务逻辑完美对齐，实现了精确的数据追踪和告警。
-   **清晰性：** 通过分离 `metricType`、`monitoring_point` 和 `fault_name`，数据模型变得更易于理解和自我解释。
-   **简洁性：** 将“开关值”作为标准数值处理的决定，避免了不必要的数据模型复杂性。
-   **可扩展性：** 经过重构的结构非常健壮，未来可以轻松地容纳新的监测点或规则。
-   **数据一致性：** 该计划包含了对现有数据的修正，并确保所有测试数据都与新模式保持一致，从而保证了整个系统的一致性。
