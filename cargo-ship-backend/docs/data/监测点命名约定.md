# 监测点命名约定

## 概述

监测点 (Monitoring Point) 是船舶货物管理系统中用于精确标识业务监测点的核心概念。本文档定义了监测点的命名约定、使用规范和最佳实践。

## 为什么需要监测点?

### 问题背景

在早期的数据模型中,系统仅使用 `metricType`(指标类型)来标识时序数据,例如:
- `voltage` (电压)
- `temperature` (温度)
- `current` (电流)

但是,同一设备可能有多个相同物理类型但业务含义不同的监测点:
- "总电压" 和 "单体电压" 都是 `voltage` 类型
- "最高单体温度" 和 "最低单体温度" 都是 `temperature` 类型
- "电机温度" 和 "轴承温度" 都是 `temperature` 类型

仅使用 `metricType` 无法区分这些监测点,导致:
1. 无法为特定业务监测点配置独立的告警阈值
2. 无法精确查询某个监测点的历史数据
3. 告警记录中缺少业务上下文,操作员难以理解问题

### 解决方案

通过引入 `monitoringPoint` 字段,实现:
- **精确标识**: 每条时序数据明确标识其业务监测点
- **精确匹配**: 告警规则基于 `(设备ID, 监测点)` 组合进行匹配
- **业务语义**: 使用自然语言描述监测点,便于操作员理解

## 命名约定

### 基本规则

1. **使用中文自然语言**: 监测点名称应使用适当大写的中文,便于操作员理解
   - ✅ 正确: "总电压"、"最高单体温度"、"左主机转速"
   - ❌ 错误: "zongdianya"、"total_voltage"、"TEMP_MAX"

2. **与客户文档保持一致**: 监测点名称应与客户需求文档中的术语保持一致
   - 参考 `docs/data/` 目录中的设备监测数据文档
   - 确保操作员熟悉的术语在系统中得到准确体现

3. **简洁明确**: 名称应简洁但足够明确,避免歧义
   - ✅ 正确: "总电压"
   - ❌ 错误: "电池组总的电压值"

4. **长度限制**: 监测点名称最长 100 个字符
   - 通常建议控制在 2-10 个汉字
   - 避免过长的描述性文字

### 命名模式

根据监测点的性质,推荐使用以下命名模式:

#### 1. 聚合型监测点
对于表示总计、平均、最大、最小等聚合值的监测点:
```
[聚合类型] + [指标名称]
```

示例:
- "总电压" (总计)
- "平均电压" (平均值)
- "最高单体温度" (最大值)
- "最低单体温度" (最小值)
- "总电流" (总计)

#### 2. 位置型监测点
对于表示特定位置或部件的监测点:
```
[位置/部件] + [指标名称]
```

示例:
- "左主机转速"
- "右主机转速"
- "电机温度"
- "轴承温度"
- "1#电池组电压"
- "2#电池组电压"

#### 3. 单体型监测点
对于表示单个单元的监测点:
```
"单体" + [指标名称]
```

示例:
- "单体电压"
- "单体温度"
- "单体内阻"

#### 4. 组合型监测点
对于需要多个限定词的监测点:
```
[位置] + [聚合类型] + [指标名称]
```

示例:
- "左舷最高温度"
- "右舷最低电压"
- "主机平均转速"

## 按设备类型的监测点示例

### 电池装置系统

| 监测点名称 | metricType | 描述 | 典型阈值 |
|-----------|-----------|------|---------|
| 总电压 | voltage | 电池组总电压 | 上限: 84V, 下限: 60V |
| 单体电压 | voltage | 单个电池单体电压 | 上限: 4.2V, 下限: 2.8V |
| 总电流 | current | 电池组总电流 | 上限: 200A |
| 最高单体温度 | temperature | 所有单体中的最高温度 | 上限: 60°C |
| 最低单体温度 | temperature | 所有单体中的最低温度 | 下限: -10°C |
| 单体温差 | temperature | 最高与最低单体温度差 | 上限: 10°C |
| 绝缘电阻 | resistance | 电池组绝缘电阻 | 下限: 100kΩ |

### 推进系统

| 监测点名称 | metricType | 描述 | 典型阈值 |
|-----------|-----------|------|---------|
| 左主机转速 | speed | 左舷主机转速 | 上限: 3000 rpm |
| 右主机转速 | speed | 右舷主机转速 | 上限: 3000 rpm |
| 电机温度 | temperature | 推进电机温度 | 上限: 90°C |
| 轴承温度 | temperature | 推进轴承温度 | 上限: 80°C |
| 电机电流 | current | 推进电机电流 | 上限: 150A |
| 振动 | vibration | 推进系统振动 | 上限: 15 mm/s |

## 使用规范

### 在时序数据中使用

创建时序数据时,应始终提供 `monitoringPoint` 字段:

```typescript
{
  "equipmentId": "battery-system-001",
  "timestamp": "2025-11-20T10:30:00Z",
  "metricType": "voltage",
  "monitoringPoint": "总电压",  // 明确标识业务监测点
  "value": 72.5,
  "unit": "V"
}
```

### 在阈值配置中使用

创建告警阈值时,必须提供 `monitoringPoint` 字段:

```typescript
{
  "equipmentId": "battery-system-001",
  "metricType": "voltage",
  "monitoringPoint": "总电压",  // 精确匹配监测点
  "faultName": "总压过压",
  "upperLimit": 84.0,
  "duration": 300000,
  "severity": "high",
  "recommendedAction": "1. 停止充电\n2. 检查充电系统\n3. 检查BMS均衡功能"
}
```

### 在查询中使用

查询特定监测点的数据:

```typescript
// 查询总电压的历史数据
GET /api/monitoring/data?equipmentId=xxx&monitoringPoint=总电压&startTime=xxx&endTime=xxx

// 查询总电压的阈值配置
GET /api/alarm/thresholds?equipmentId=xxx&monitoringPoint=总电压

// 查询总电压相关的告警记录
GET /api/alarm/records?equipmentId=xxx&monitoringPoint=总电压
```

## 监测点验证

### 应用层验证

系统在应用层对监测点进行验证:

1. **格式验证**: 确保监测点名称符合基本格式要求
   - 非空字符串
   - 长度不超过 100 个字符
   - 不包含特殊控制字符

2. **一致性验证**: 确保同一设备的同一监测点始终使用相同的名称
   - 通过历史数据分析检测拼写变化
   - 在创建新数据时提示可能的拼写错误

3. **设备类型验证**: 确保监测点与设备类型匹配
   - 每个设备类型有预定义的监测点集合
   - 创建新监测点时需要验证其合理性

### 客户规则脚本验证

使用 `scripts/seed-customer-rules.ts` 脚本填充客户规则时:
- 脚本自动从客户文档中提取监测点名称
- 确保监测点名称与文档完全一致
- 验证设备ID和监测点的对应关系

## 最佳实践

### 1. 保持命名一致性

- 在同一设备类型的所有实例中使用相同的监测点名称
- 定期审查监测点使用情况,合并重复或相似的命名

### 2. 文档先行

- 在实施前,先在客户需求文档中明确所有监测点
- 使用客户规则脚本确保文档与数据库的一致性

### 3. 避免修改现有监测点

- 监测点名称一旦确定,应避免修改
- 如需修改,需要:
  1. 更新所有相关的阈值配置
  2. 更新历史数据(如果必要)
  3. 通知所有相关操作员

### 4. 使用业务术语

- 优先使用操作员熟悉的业务术语
- 避免使用过于技术化的名称
- 在命名时咨询现场操作人员

### 5. 记录特殊监测点

- 对于非标准的监测点,在文档中记录其特殊含义
- 说明为什么需要这个监测点
- 提供使用场景和告警处理指南

## 迁移指南

### 从旧数据模型迁移

如果您的系统之前没有使用监测点:

1. **分析现有数据**: 
   - 检查每个设备有哪些 `metricType`
   - 识别哪些指标需要细分为多个监测点

2. **定义监测点映射**:
   ```
   设备A + voltage → "总电压"
   设备A + voltage → "单体电压"
   设备A + temperature → "最高单体温度"
   设备A + temperature → "最低单体温度"
   ```

3. **更新阈值配置**:
   - 为每个现有阈值添加 `monitoringPoint` 字段
   - 确保告警逻辑能够正确匹配

4. **逐步推广**:
   - 新数据必须包含 `monitoringPoint`
   - 旧数据保持兼容(允许 NULL)
   - 随着时间推移,旧数据自然淘汰

## 常见问题

### Q1: 监测点名称可以重复吗?

A: 同一设备的不同监测点必须有不同的名称。不同设备可以使用相同的监测点名称(例如多个电池系统都有"总电压"监测点)。

### Q2: 如何处理临时监测点?

A: 对于临时测试或调试的监测点,建议:
- 使用明确的前缀标识,如 "测试-xxx"
- 在测试结束后及时清理
- 不要为临时监测点配置生产告警规则

### Q3: 监测点名称可以包含数字吗?

A: 可以,但建议使用中文数字或带 # 号的格式,例如 "1#电池组" 或 "第一组电压"。

### Q4: 如何处理监测点的拼写错误?

A: 
- 应用层验证会提示可能的拼写错误
- 如果发现错误,应尽快修正
- 使用数据库更新语句批量修正历史数据

### Q5: 是否需要为每个传感器创建监测点?

A: 不一定。监测点是业务概念,不是物理传感器。多个传感器的数据可以聚合到一个监测点,一个传感器也可以提供多个监测点的数据。

## 参考资料

- 客户需求文档: `docs/data/电池装置系统监测数据及故障阈值.md`
- 客户需求文档: `docs/data/推进系统监测数据及故障阈值.md`
- 数据库设计: `docs/analysis/监控告警重构分析.md`
- API 文档: 通过 Swagger UI 查看 (`/api-docs`)
- 客户规则脚本: `scripts/seed-customer-rules.ts`
