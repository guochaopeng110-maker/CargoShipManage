# 设备监控需求分析与数据库重构方案 (V3 - 最终版)

## 1. 背景与目标

本文档是经过多次深入沟通和修正后形成的最终方案，旨在将客户提供的最新设备监控需求完整、准确地集成到现有系统中。方案的核心是优化数据模型，以精确反映业务逻辑，并确保系统的可扩展性和数据一致性。

## 2. 核心需求澄清

在最终的讨论中，我们对几个关键概念达成了明确且一致的共识：

### 2.1. “监测点” (Monitoring Point) 的核心作用

- **最终澄清**: “监测点” (如 `总电压`, `单体电压`) 是一个关键的业务标识符，必须在数据模型中显式体现。`metricType` (如 `voltage`) 仅代表数据的物理类型，不足以区分来自同一设备但业务含义不同的数据源。
- **结论**: 必须在 `time_series_data` (时序数据) 和 `threshold_configs` (告警规则) 两个核心表中都增加 `monitoring_point` 字段，以确保数据的唯一标识和告警规则的精确匹配。

### 2.2. “故障名称”的归属

- **最终澄清**: “故障名称” (如 `总压过压`) 是与具体 **告警规则** 相关联的描述，它定义了当某个监测点的数值触发特定条件时所发生的故障。
- **结论**: `fault_name` 字段应属于 `threshold_configs` 表，与 `monitoring_point` 和阈值（如 `upper_limit`）共同定义一条完整的告警规则。

### 2.3. “开关值”的简化处理

- **最终澄清**: “开关值” (0/1) 应作为普通的 **数值** 对待，而不是一种特殊的“离散事件”。
- **结论**: 无需为“开关值”引入复杂的数据模型。它可以直接存入 `time_series_data` 的 `value` 列，并通过 `threshold_configs` 中标准的数值比较规则（如 `lower_limit: 0.5`）来触发告警。

### 2.4. 设备粒度与“处理措施”

- **共识**: 数据库中的设备应以“设备系统”（如“电池装置系统”）为单位进行管理。同时，每条告警规则都应包含明确的“处理措施”。
- **结论**: 需要修正 `equipment` 表中的种子数据，并在 `threshold_configs` 表中增加 `recommended_action` 字段。

## 3. 最终重构方案

这是一个完整的、自底向上的四步重构计划，涵盖了从数据层到应用层的全部必要修改。

### 第 1 步：数据库与实体层重构

**目标**: 调整数据库表结构，使其能精确地表达业务需求。

1.  **修改实体文件**:
    *   `src/database/entities/time_series_data.entity.ts`:
        *   增加 `monitoring_point` (字符串) 字段。
    *   `src/database/entities/threshold-config.entity.ts`:
        *   增加 `monitoring_point` (字符串) 字段。
        *   增加 `fault_name` (字符串) 字段。
        *   增加 `recommended_action` (字符串) 字段。
2.  **创建数据库迁移**:
    *   创建一个新的迁移文件，包含所有必要的 `ALTER TABLE` 语句，一次性完成上述所有表的结构更新。

### 第 2 步：应用层代码适配

**目标**: 修改所有与变动表相关的应用代码，以适应新的数据结构。

1.  **更新 DTOs (数据传输对象)**:
    *   在 `monitoring` 和 `alarm` 等模块的 DTO 文件中，添加或修改字段以匹配新的表结构，例如为数据上报和查询接口加入 `monitoring_point`。
2.  **更新 Services (服务层逻辑)**:
    *   **`ThresholdService`**: 重构 `create`/`update` 方法，使其能够处理和验证包含 `monitoring_point`, `fault_name`, `recommended_action` 的新规则。
    *   **`MonitoringService`**: 修改数据接收和查询逻辑，以正确处理和使用 `monitoring_point`。
    *   **`AlarmService`**: 重构告警触发的核心逻辑，使其能够根据 `equipment_id` + `monitoring_point` 精确匹配告警规则，并能在生成告警记录时，将规则中的 `fault_name` 等信息一并存入。
    *   **`QueryService` & `ExportService`**: 更新统计和导出功能，以支持按 `monitoring_point` 进行更精确的数据聚合与输出。

### 第 3 步：核心数据与测试数据修正

**目标**: 清理旧的错误数据，并使测试数据与新架构保持同步。

1.  **修正 `equipment` 表数据**:
    *   创建一个新的数据库迁移文件，用于**删除**旧的、粒度过细的设备记录，并**插入**以“设备系统”为单位的正确设备记录。
2.  **重写测试数据生成逻辑**:
    *   彻底修改 `1732400000000-SeedTestData.ts` 迁移文件。新的逻辑将生成完全符合新表结构和新设备列表的测试数据，并为 `monitoring_point` 等所有新字段提供有效值。

### 第 4 步：最终数据填充

**目标**: 将客户提供的文档中的所有监控规则，安全、准确地录入到数据库中。

-   在完成以上所有重构和修正之后，创建一个独立的自动化脚本 (`scripts/seed-customer-rules.ts`)。该脚本将解析 `docs/data/` 中的文档，并根据新的、功能完备的 `threshold_configs` 表结构，将所有规则批量、正确地存入数据库。

---
这份方案现已包含我们所有讨论的共识，并形成了清晰、可执行的步骤。
