# 告警阈值能力

## ADDED Requirements

### Requirement: 故障名称关联
系统 MUST 将每个阈值配置与特定的故障名称关联,该故障名称用业务术语描述告警条件。

#### Scenario: 创建带故障名称的阈值
- **假设** 设备的监测点为"总电压"
- **当** 创建阈值规则,upperLimit=683.1V,faultName="总压过压"
- **那么** 规则与故障名称一起存储
- **并且** 触发的告警显示故障名称供操作员理解

#### Scenario: 按故障名称查询告警
- **假设** 存在多个不同故障名称的告警记录
- **当** 查询所有"总压过压"告警时
- **那么** 仅返回匹配该故障名称的告警
- **并且** 操作员可以跟踪特定故障模式

#### Scenario: 支持每个监测点的多个故障
- **假设** 监测点为"总电压"
- **当** 创建"总压过压"(上限)和"总压欠压"(下限)规则时
- **那么** 两个规则都存储不同的故障名称
- **并且** 每个规则独立触发相应的告警

### Requirement: 处理措施指导
系统 MUST 为每个阈值规则存储和显示建议的纠正措施,以在告警事件期间指导操作员。

#### Scenario: 在告警时显示处理措施
- **假设** 阈值规则的 recommendedAction="检查电池单体均衡和充电系统"
- **当** 该规则触发告警时
- **那么** 告警通知中包含处理措施
- **并且** 操作员收到即时的响应指导

#### Scenario: 更新处理措施
- **假设** 现有阈值规则有处理措施
- **当** 更新规则以改进措施指导时
- **那么** 存储新的措施文本
- **并且** 未来的告警显示更新的指导

#### Scenario: 支持多步骤措施
- **假设** 复杂告警需要多个响应步骤
- **当** 处理措施包含格式化的多行文本时
- **那么** 系统保留格式和换行符
- **并且** 操作员可以遵循分步程序

### Requirement: 基于监测点的阈值匹配
系统 MUST 基于设备 ID 和监测点的组合来匹配告警阈值,实现精确的告警规则。

#### Scenario: 为特定监测点触发告警
- **假设** 设备有"总电压"(683.1V)和"单体电压"(3.65V)的阈值
- **当** 传入数据显示 metricType=voltage, monitoringPoint="总电压", value=690V
- **那么** 仅评估"总电压"阈值
- **并且** 不触发"单体电压"阈值

#### Scenario: 相同指标类型的独立阈值
- **假设** 设备有多个温度监测点
- **当** "轴承温度"超过其阈值但"绕组温度"未超过时
- **那么** 仅触发轴承温度告警
- **并且** 每个监测点都有独立的阈值执行

#### Scenario: 监测点无阈值匹配
- **假设** 监测点未配置阈值
- **当** 为该监测点记录数据时
- **那么** 不进行告警评估
- **并且** 数据正常存储不报错

## ADDED Requirements

### Requirement: 阈值配置
系统 MUST 允许配置告警阈值,包括设备 ID、监测点、指标类型、上下限、持续时间、严重程度、故障名称和处理措施。

#### Scenario: 创建完整的阈值配置
- **假设** 设备"电池装置系统"的监测点为"总电压"
- **当** 创建阈值,equipmentId、monitoringPoint="总电压"、metricType=voltage、upperLimit=683.1、lowerLimit=584.1、duration=5000ms、severity=medium、faultName="总压异常"、recommendedAction="检查稳压器"
- **那么** 所有字段验证并存储
- **并且** 规则激活用于告警监控

#### Scenario: 验证监测点一致性
- **假设** 正在创建阈值配置
- **当** metricType 与监测点的预期类型不匹配时
- **那么** 验证失败并返回清晰的错误消息
- **并且** 配置被拒绝

#### Scenario: 按监测点查询阈值
- **假设** 设备有多个阈值
- **当** 查询特定监测点的阈值时
- **那么** 仅返回匹配的阈值配置
- **并且** 包含相关设备和监测点详情

### Requirement: 告警记录存储（增强）
系统 MUST 创建告警记录,包括设备 ID、监测点、阈值配置、触发值、故障名称、处理措施、严重程度和时间戳。

#### Scenario: 记录带业务上下文的告警
- **假设** 阈值规则有监测点、故障名称和处理措施
- **当** 触发告警时
- **那么** 告警记录包含所有业务上下文字段
- **并且** 操作员有完整的响应信息

#### Scenario: 将告警链接到阈值配置
- **假设** 告警由阈值规则触发
- **当** 创建告警记录时
- **那么** 它引用阈值配置 ID
- **并且** 故障名称和处理措施复制到告警以保证历史准确性

#### Scenario: 在阈值更改后保留告警上下文
- **假设** 存在历史告警记录及其故障名称和处理措施
- **当** 原始阈值规则被修改或删除时
- **那么** 告警记录保留其原始上下文
- **并且** 历史数据保持准确和完整
