# 任务清单: 标准化CRUD页面模板

## 变更ID
`standardize-crud-pages`

## 任务概述

本任务清单将重构工作分解为小的、可验证的工作项，每个任务都应该：
- ✅ 可在1-4小时内完成
- ✅ 有明确的验收标准
- ✅ 产生用户可见的进展
- ✅ 包含必要的测试

## 阶段1: 准备和基础设施 (2天)

### 1.1 创建类型定义和接口 ⚡ 优先级: 高
**预估时间**: 2小时
**负责人**: TBD
**依赖**: 无

**任务**:
- [ ] 在 `src/types/crud.ts` 创建通用CRUD类型定义
- [ ] 定义 `CRUDPageTemplateProps` 接口
- [ ] 定义 `CRUDDataTableProps` 接口
- [ ] 定义 `CRUDFormModalProps` 接口
- [ ] 定义 `ColumnDef` 和 `FormFieldConfig` 接口
- [ ] 添加JSDoc文档注释

**验收标准**:
- [x] 所有接口都有完整的TypeScript类型定义
- [x] 接口支持泛型 `<T>` 参数
- [x] 有完整的JSDoc注释
- [x] 通过 `tsc --noEmit` 类型检查

**测试**:
```bash
npx tsc --noEmit
```

---

### 1.2 创建通用工具函数 ⚡ 优先级: 中
**预估时间**: 1小时
**负责人**: TBD
**依赖**: 1.1

**任务**:
- [ ] 创建 `src/utils/crud-helpers.ts`
- [ ] 实现防抖搜索函数 `useDebouncedSearch`
- [ ] 实现分页计算函数 `calculatePagination`
- [ ] 实现排序辅助函数 `sortData`
- [ ] 添加单元测试

**验收标准**:
- [x] 所有工具函数都有单元测试
- [x] 测试覆盖率 > 90%
- [x] 函数有完整的TypeScript类型

**测试**:
```bash
npm test -- crud-helpers.test.ts
```

---

## 阶段2: 核心组件开发 (3天)

### 2.1 创建 CRUDActionBar 组件 ⚡ 优先级: 高
**预估时间**: 2小时
**负责人**: TBD
**依赖**: 1.1

**任务**:
- [ ] 创建 `src/components/crud/CRUDActionBar.tsx`
- [ ] 实现标题和描述显示
- [ ] 实现添加按钮（带权限控制）
- [ ] 实现自定义操作区域渲染
- [ ] 添加响应式样式
- [ ] 编写组件测试

**验收标准**:
- [x] 组件正确显示标题和描述
- [x] 添加按钮在有权限时可见，无权限时隐藏
- [x] 自定义操作区域正确渲染
- [x] 组件在移动端和桌面端都显示正常
- [x] 测试覆盖率 > 85%

**测试**:
```bash
npm test -- CRUDActionBar.test.tsx
```

---

### 2.2 创建 CRUDSearchBar 组件 ⚡ 优先级: 高
**预估时间**: 2小时
**负责人**: TBD
**依赖**: 1.1, 1.2

**任务**:
- [ ] 创建 `src/components/crud/CRUDSearchBar.tsx`
- [ ] 实现搜索输入框（带防抖）
- [ ] 实现筛选器下拉菜单
- [ ] 实现清除按钮
- [ ] 添加搜索图标和加载状态
- [ ] 编写组件测试

**验收标准**:
- [x] 搜索输入300ms防抖
- [x] 筛选器正确触发回调
- [x] 清除按钮重置所有筛选
- [x] 显示当前筛选条件数量
- [x] 测试覆盖率 > 85%

**测试**:
```bash
npm test -- CRUDSearchBar.test.tsx
```

---

### 2.3 创建 CRUDDataTable 组件 (核心组件) ⚡ 优先级: 最高
**预估时间**: 6小时
**负责人**: TBD
**依赖**: 1.1

**任务**:
- [ ] 创建 `src/components/crud/CRUDDataTable.tsx`
- [ ] 实现表格头部（带排序功能）
- [ ] 实现表格主体（支持自定义列渲染）
- [ ] 实现固定操作列
- [ ] 实现分页控件
- [ ] 实现加载状态（骨架屏）
- [ ] 实现空状态
- [ ] 实现错误状态
- [ ] 添加响应式设计（移动端卡片视图）
- [ ] 编写组件测试

**验收标准**:
- [x] 表格正确渲染所有列
- [x] 排序功能正常工作
- [x] 分页控件正确显示和交互
- [x] 加载状态显示骨架屏
- [x] 空状态显示友好提示
- [x] 错误状态显示错误信息
- [x] 移动端显示为卡片列表
- [x] 操作列固定在右侧
- [x] 测试覆盖率 > 80%

**测试**:
```bash
npm test -- CRUDDataTable.test.tsx
```

---

### 2.4 创建 CRUDFormModal 组件 ⚡ 优先级: 高
**预估时间**: 5小时
**负责人**: TBD
**依赖**: 1.1

**任务**:
- [ ] 创建 `src/components/crud/CRUDFormModal.tsx`
- [ ] 集成 React Hook Form
- [ ] 实现动态表单字段渲染
- [ ] 实现表单验证（内置 + 自定义）
- [ ] 实现提交和取消处理
- [ ] 实现加载状态
- [ ] 实现错误显示
- [ ] 支持多种字段类型（text, email, select, textarea等）
- [ ] 编写组件测试

**验收标准**:
- [x] 表单字段根据配置动态渲染
- [x] 表单验证正常工作
- [x] 提交时显示加载状态
- [x] 错误正确显示在对应字段下
- [x] 取消按钮清空表单
- [x] 编辑模式正确填充默认值
- [x] 测试覆盖率 > 80%

**测试**:
```bash
npm test -- CRUDFormModal.test.tsx
```

---

### 2.5 创建 CRUDPageTemplate 组件 (顶层组件) ⚡ 优先级: 最高
**预估时间**: 4小时
**负责人**: TBD
**依赖**: 2.1, 2.2, 2.3

**任务**:
- [ ] 创建 `src/components/crud/CRUDPageTemplate.tsx`
- [ ] 组装 ActionBar、SearchBar、DataTable 组件
- [ ] 实现数据流协调
- [ ] 实现错误处理和显示
- [ ] 实现权限控制逻辑
- [ ] 添加性能优化（React.memo）
- [ ] 编写集成测试

**验收标准**:
- [x] 所有子组件正确组装
- [x] 数据流通畅（搜索、筛选、分页）
- [x] 错误统一显示在顶部
- [x] 权限控制正确工作
- [x] 组件使用React.memo优化
- [x] 集成测试覆盖主要场景

**测试**:
```bash
npm test -- CRUDPageTemplate.test.tsx
```

---

## 阶段3: Store标准化 (1天)

### 3.1 定义标准Store接口 ⚡ 优先级: 高
**预估时间**: 1小时
**负责人**: TBD
**依赖**: 1.1

**任务**:
- [ ] 创建 `src/types/crud-store.ts`
- [ ] 定义 `CRUDStoreState<T>` 接口
- [ ] 定义 `CRUDStoreActions<T, CreateDTO, UpdateDTO>` 接口
- [ ] 添加JSDoc文档

**验收标准**:
- [x] 接口定义清晰完整
- [x] 支持泛型参数
- [x] 有详细的JSDoc注释

---

### 3.2 重构 equipment-store ⚡ 优先级: 中
**预估时间**: 2小时
**负责人**: TBD
**依赖**: 3.1

**任务**:
- [ ] 更新 `equipment-store.ts` 符合标准接口
- [ ] 确保所有Actions实现完整
- [ ] 添加乐观更新逻辑（删除操作）
- [ ] 更新单元测试

**验收标准**:
- [x] Store符合 `CRUDStoreState` 和 `CRUDStoreActions` 接口
- [x] 删除操作使用乐观更新
- [x] 所有Actions有错误处理
- [x] 单元测试通过

**测试**:
```bash
npm test -- equipment-store.test.ts
```

---

### 3.3 重构 auth-store (用户管理部分) ⚡ 优先级: 中
**预估时间**: 3小时
**负责人**: TBD
**依赖**: 3.1

**任务**:
- [ ] 将用户管理逻辑分离到 `user-store.ts`
- [ ] 实现符合标准接口的用户CRUD操作
- [ ] 更新 auth-store 引用
- [ ] 添加单元测试

**验收标准**:
- [x] 用户管理Store独立存在
- [x] 符合标准CRUD接口
- [x] auth-store正确引用user-store
- [x] 单元测试通过

**测试**:
```bash
npm test -- user-store.test.ts
npm test -- auth-store.test.ts
```

---

### 3.4 验证 threshold-store ⚡ 优先级: 低
**预估时间**: 1小时
**负责人**: TBD
**依赖**: 3.1

**任务**:
- [ ] 检查 `threshold-store.ts` 是否符合标准
- [ ] 进行必要的微调
- [ ] 添加缺失的测试

**验收标准**:
- [x] Store符合标准接口
- [x] 测试覆盖率 > 80%

**测试**:
```bash
npm test -- threshold-store.test.ts
```

---

## 阶段4: 页面重构 (3.5天)

### 4.1 重构 DeviceManagementPage (试点页面) ⚡ 优先级: 最高
**预估时间**: 4小时
**负责人**: TBD
**依赖**: 2.5, 3.2

**任务**:
- [ ] 备份原文件为 `DeviceManagementPage.legacy.tsx`
- [ ] 使用 `CRUDPageTemplate` 重写 `DeviceManagementPage.tsx`
- [ ] 定义表格列配置
- [ ] 定义表单字段配置
- [ ] 实现事件处理函数
- [ ] 集成权限控制
- [ ] 手动测试所有功能
- [ ] 添加E2E测试

**验收标准**:
- [x] 页面代码减少至 < 300行
- [x] 所有原有功能正常工作（新增、编辑、删除、搜索、分页）
- [x] 权限控制正常
- [x] E2E测试通过
- [x] 用户体验保持一致或更好

**测试**:
```bash
# 手动测试
npm run dev
# 访问 /devices

# E2E测试
npm run test:e2e -- device-management
```

---

### 4.2 重构 UserManagementPage ⚡ 优先级: 高
**预估时间**: 4小时
**负责人**: TBD
**依赖**: 2.5, 3.3, 4.1 (试点成功)

**任务**:
- [ ] 备份原文件为 `UserManagementPage.legacy.tsx`
- [ ] 使用 `CRUDPageTemplate` 重写 `UserManagementPage.tsx`
- [ ] 定义用户表格列配置
- [ ] 定义用户表单字段配置
- [ ] 实现密码字段特殊处理
- [ ] 实现角色选择器
- [ ] 手动测试所有功能
- [ ] 添加E2E测试

**验收标准**:
- [x] 页面代码减少至 < 300行
- [x] 用户CRUD功能正常
- [x] 密码字段编辑时可选
- [x] 角色分配正常工作
- [x] E2E测试通过

**测试**:
```bash
npm run test:e2e -- user-management
```

---

### 4.3 创建/重构 ThresholdManagementPage ⚡ 优先级: 中
**预估时间**: 4小时
**负责人**: TBD
**依赖**: 2.5, 3.4, 4.1 (试点成功)

**任务**:
- [ ] 检查是否存在阈值管理页面
- [ ] 如不存在，创建新页面；如存在，备份并重写
- [ ] 使用 `CRUDPageTemplate` 实现页面
- [ ] 定义阈值表格列配置
- [ ] 定义阈值表单字段配置
- [ ] 实现阈值测试功能
- [ ] 手动测试所有功能
- [ ] 添加E2E测试

**验收标准**:
- [x] 页面使用统一模板
- [x] 阈值CRUD功能正常
- [x] 阈值测试功能正常
- [x] E2E测试通过

**测试**:
```bash
npm run test:e2e -- threshold-management
```

---

### 4.4 重构 RoleManagementPage (展示页面) ⚡ 优先级: 中
**预估时间**: 2小时
**负责人**: TBD
**依赖**: 2.1, 2.2 (可复用部分基础组件)

**任务**:
- [ ] 备份原文件为 `RoleManagementPage.legacy.tsx`
- [ ] 重构为轻量级的只读展示页面
- [ ] 使用 `CRUDActionBar` 和 `CRUDDataTable` 的只读模式
- [ ] 移除所有CRUD操作相关代码
- [ ] 优化角色权限信息展示布局
- [ ] 手动测试页面显示
- [ ] 添加E2E测试

**验收标准**:
- [x] 页面代码减少至 < 200行
- [x] 仅展示3个固定角色信息
- [x] 无任何编辑/删除/添加功能
- [x] 页面加载和显示正常
- [x] E2E测试通过

**测试**:
```bash
npm run test:e2e -- role-management
```

---

## 阶段5: 测试和优化 (2天)

### 5.1 集成测试 ⚡ 优先级: 高
**预估时间**: 3小时
**负责人**: TBD
**依赖**: 4.1, 4.2, 4.3, 4.4

**任务**:
- [ ] 编写跨页面集成测试
- [ ] 测试页面间导航
- [ ] 测试权限控制在所有页面的一致性
- [ ] 测试错误处理
- [ ] 测试边界情况（空数据、网络错误等）

**验收标准**:
- [x] 所有集成测试通过
- [x] 测试覆盖主要用户流程
- [x] 测试覆盖率 > 75%

**测试**:
```bash
npm run test:integration
```

---

### 5.2 性能测试和优化 ⚡ 优先级: 中
**预估时间**: 2小时
**负责人**: TBD
**依赖**: 4.1, 4.2, 4.3, 4.4

**任务**:
- [ ] 使用 React DevTools Profiler 分析性能
- [ ] 识别不必要的重渲染
- [ ] 优化组件memo化
- [ ] 优化大列表渲染（考虑虚拟滚动）
- [ ] 测试页面加载时间

**验收标准**:
- [x] 页面首次渲染时间 < 500ms
- [x] 列表滚动流畅（60fps）
- [x] 搜索响应时间 < 300ms
- [x] 无明显的性能回退

**测试**:
```bash
npm run test:performance
```

---

### 5.3 可访问性测试 ⚡ 优先级: 中
**预估时间**: 2小时
**负责人**: TBD
**依赖**: 4.1, 4.2, 4.3, 4.4

**任务**:
- [ ] 使用 axe DevTools 进行可访问性检查
- [ ] 添加必要的 ARIA 标签
- [ ] 测试键盘导航
- [ ] 测试屏幕阅读器兼容性
- [ ] 修复发现的问题

**验收标准**:
- [x] axe DevTools 无严重问题
- [x] 所有交互元素可通过键盘访问
- [x] 表单有适当的标签和错误提示
- [x] 颜色对比度符合WCAG AA标准

**测试**:
```bash
npm run test:a11y
```

---

### 5.4 浏览器兼容性测试 ⚡ 优先级: 低
**预估时间**: 2小时
**负责人**: TBD
**依赖**: 4.1, 4.2, 4.3, 4.4

**任务**:
- [ ] 在 Chrome 最新版测试
- [ ] 在 Firefox 最新版测试
- [ ] 在 Safari 最新版测试
- [ ] 在 Edge 最新版测试
- [ ] 修复兼容性问题

**验收标准**:
- [x] 所有主流浏览器功能正常
- [x] 样式在所有浏览器中一致
- [x] 无JavaScript错误

---

## 阶段6: 文档和清理 (1天)

### 6.1 编写开发文档 ⚡ 优先级: 高
**预估时间**: 3小时
**负责人**: TBD
**依赖**: 所有开发任务完成

**任务**:
- [ ] 创建 `docs/guides/crud-page-template.md`
- [ ] 编写快速入门指南
- [ ] 编写完整的API文档
- [ ] 提供示例代码
- [ ] 创建故障排除指南

**验收标准**:
- [x] 文档清晰易懂
- [x] 包含完整的示例
- [x] 新开发者可以根据文档创建新页面

---

### 6.2 创建Storybook文档 ⚡ 优先级: 中
**预估时间**: 2小时
**负责人**: TBD
**依赖**: 2.1, 2.2, 2.3, 2.4, 2.5

**任务**:
- [ ] 为所有CRUD组件创建Story
- [ ] 添加交互式参数控制
- [ ] 添加使用示例
- [ ] 部署Storybook

**验收标准**:
- [x] 所有组件有Story
- [x] Story有完整的参数控制
- [x] Storybook可访问

**测试**:
```bash
npm run storybook
```

---

### 6.3 代码审查和重构 ⚡ 优先级: 中
**预估时间**: 2小时
**负责人**: TBD
**依赖**: 所有开发任务完成

**任务**:
- [ ] 进行代码审查
- [ ] 移除重复代码
- [ ] 优化命名和注释
- [ ] 确保代码风格一致
- [ ] 运行Linter和Formatter

**验收标准**:
- [x] ESLint无错误和警告
- [x] Prettier格式化一致
- [x] 代码审查通过
- [x] 无TODO或FIXME注释

**测试**:
```bash
npm run lint
npm run format
```

---

### 6.4 清理和删除旧代码 ⚡ 优先级: 低
**预估时间**: 1小时
**负责人**: TBD
**依赖**: 所有测试通过

**任务**:
- [ ] 确认所有功能正常
- [ ] 删除 `.legacy.tsx` 备份文件
- [ ] 移除未使用的导入和函数
- [ ] 更新相关导入路径
- [ ] 提交最终代码

**验收标准**:
- [x] 项目中无 `.legacy.tsx` 文件
- [x] 无未使用的代码
- [x] 所有导入正确
- [x] Git提交历史清晰

---

## 任务统计

### 按优先级
- **最高优先级**: 3个任务
- **高优先级**: 10个任务
- **中优先级**: 10个任务
- **低优先级**: 2个任务

### 按阶段
- **阶段1 (准备)**: 2个任务, 3小时
- **阶段2 (核心组件)**: 5个任务, 21小时
- **阶段3 (Store)**: 4个任务, 7小时
- **阶段4 (页面重构)**: 4个任务, 14小时
- **阶段5 (测试优化)**: 4个任务, 9小时
- **阶段6 (文档清理)**: 4个任务, 8小时

### 总计
- **任务总数**: 23个
- **预估总时间**: 62小时 (约8个工作日)

## 风险任务

以下任务具有较高风险，需要特别关注：

1. **2.3 创建 CRUDDataTable 组件** - 复杂度高，需要处理多种状态
2. **2.4 创建 CRUDFormModal 组件** - 需要集成React Hook Form，验证逻辑复杂
3. **3.3 重构 auth-store** - 涉及核心认证逻辑，需谨慎处理
4. **4.1 重构 DeviceManagementPage** - 第一个试点，可能发现设计问题

## 并行任务机会

以下任务可以并行进行：

- **阶段1**: 1.1 和 1.2 可以并行
- **阶段2**: 2.1 和 2.2 可以并行（依赖1.1完成后）
- **阶段3**: 3.2, 3.3, 3.4 可以并行（依赖3.1完成后）
- **阶段4**: 4.2, 4.3 可以并行（依赖4.1试点成功后），4.4 可以在2.1和2.2完成后独立进行

## 验证检查清单

在标记任务完成前，确认：

- [ ] 代码已提交到版本控制
- [ ] 所有相关测试通过
- [ ] 代码审查已完成
- [ ] 文档已更新
- [ ] 性能无明显下降
- [ ] 无破坏性变更（或已记录）

---

**文档版本**: 1.0
**最后更新**: 2025-12-15
