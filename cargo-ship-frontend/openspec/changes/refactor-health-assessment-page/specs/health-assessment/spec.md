# 健康评估能力规范增量

## ADDED Requirements

### Requirement: "总-分-细"三段式页面布局

健康评估页面必须(SHALL)采用"总-分-细"三段式垂直布局结构，从上到下依次展示整体健康状况、各系统健康状况和历史报告详情。

#### Scenario: 用户查看整体健康概览

- **WHEN** 用户访问健康评估页面（路由 `/health`）
- **THEN** 页面从上到下依次展示：
  - 顶部区域：整船综合健康仪表盘（包含评分和等级）
  - 中部区域：系统健康卡片矩阵（展示所有核心系统的健康卡片）
  - 底部区域：历史报告列表（支持分页浏览）

#### Scenario: 页面响应式布局适配

- **WHEN** 用户在不同尺寸的屏幕上访问页面
- **THEN** 系统必须(SHALL)：
  - 在移动端（< 640px）：系统健康卡片单列显示
  - 在平板端（640px - 1024px）：系统健康卡片 2 列显示
  - 在桌面端（> 1024px）：系统健康卡片 3-4 列显示
  - 所有布局下内容清晰可读，交互元素可点击

---

### Requirement: 整船健康仪表盘展示

系统必须(SHALL)在页面顶部展示整船综合健康仪表盘，提供一目了然的整体健康状况概览。

#### Scenario: 展示整船综合健康评分

- **WHEN** 页面加载完成且健康数据可用
- **THEN** 整船健康仪表盘必须(SHALL)显示：
  - 综合健康评分（0-100 的数值）
  - 健康等级文字（如"良好"、"一般"、"较差"）
  - 根据健康等级使用不同的背景色或边框色
  - 评分使用大尺寸的仪表盘图表（GaugeChart）展示

#### Scenario: 健康等级颜色映射

- **WHEN** 健康评分在不同区间
- **THEN** 系统必须(SHALL)应用对应的颜色主题：
  - Excellent（90-100）：绿色
  - Good（80-89）：浅绿色
  - Fair（70-79）：黄色
  - Poor（60-69）：橙色
  - Critical（< 60）：红色

#### Scenario: 手动刷新健康数据

- **WHEN** 用户点击仪表盘右上角的"刷新"按钮
- **THEN** 系统必须(SHALL)：
  - 显示加载状态（刷新按钮带旋转动画）
  - 重新获取最新的系统健康评分数据
  - 更新整船综合健康评分和所有系统健康卡片
  - 刷新完成后移除加载状态

---

### Requirement: 系统健康卡片矩阵展示

系统必须(SHALL)在页面中部展示系统健康卡片矩阵，为每个核心设备系统提供独立的健康状况卡片。

#### Scenario: 展示核心系统健康卡片

- **WHEN** 页面加载完成且系统健康数据可用
- **THEN** 系统必须(SHALL)为以下核心系统各展示一个健康卡片：
  - 电池系统
  - 推进系统
  - 逆变器系统
  - 配电系统
  - 辅助系统

#### Scenario: 系统健康卡片内容展示

- **WHEN** 渲染单个系统健康卡片
- **THEN** 卡片必须(SHALL)包含以下元素：
  - 系统名称和对应图标（如电池图标）
  - 该系统的独立健康评分（0-100 数值）
  - 健康等级 Badge（根据评分动态颜色）
  - 迷你趋势图（Sparkline）展示近期健康分变化
  - 活跃告警数量徽章（右上角，数量 > 0 时显示）
  - 趋势指示图标（上升/平稳/下降箭头）

#### Scenario: 点击系统健康卡片导航

- **WHEN** 用户点击任意系统健康卡片
- **THEN** 系统必须(SHALL)：
  - 导航至该系统对应的详细监控页面
  - 例如：点击电池系统卡片 → 跳转至 `/monitoring/battery`
  - 导航过程流畅，无明显延迟

#### Scenario: 系统健康卡片悬停效果

- **WHEN** 用户鼠标悬停在系统健康卡片上
- **THEN** 卡片必须(SHALL)显示悬停效果：
  - 背景色略微变亮或边框高亮
  - 出现轻微阴影效果
  - 鼠标指针变为手型（pointer）
  - 提示用户卡片可点击

---

### Requirement: 实时健康数据更新

系统必须(SHALL)通过 WebSocket 接收实时健康数据推送，并自动更新页面上的健康评分和趋势图。

#### Scenario: 接收实时健康评分更新

- **WHEN** WebSocket 推送 `equipment:health:update` 事件
- **THEN** 系统必须(SHALL)：
  - 解析事件 payload，提取 equipmentId、score、grade、trend 等字段
  - 更新 health-store 中对应设备的健康评分数据
  - 自动触发相关 UI 组件（整船仪表盘、系统健康卡片）重新渲染
  - 整个更新过程在 500ms 内完成

#### Scenario: 实时数据防抖优化

- **WHEN** WebSocket 在短时间内推送多个健康更新事件（频率 > 2 次/秒）
- **THEN** 系统必须(SHALL)：
  - 对更新事件进行防抖处理（debounce 500ms）
  - 避免频繁的 UI 重渲染影响性能
  - 确保最新的健康数据最终被正确显示

#### Scenario: 趋势数据累积

- **WHEN** 接收到新的健康评分数据
- **THEN** 系统必须(SHALL)：
  - 将新数据点添加到该设备的趋势数据数组
  - 维护近期 10-20 个数据点（最旧的数据点被移除）
  - 更新系统健康卡片上的 Sparkline 趋势图
  - 可选：将趋势数据持久化到 localStorage

---

### Requirement: 跨 Store 数据聚合

系统必须(SHALL)聚合来自 health-store 和 alarms-store 的数据，在系统健康卡片上同时展示健康评分和活跃告警数量。

#### Scenario: 展示系统活跃告警数量

- **WHEN** 渲染系统健康卡片
- **THEN** 系统必须(SHALL)：
  - 从 alarms-store 中筛选该系统的所有告警
  - 计算状态为 PENDING 且严重程度为 HIGH 或 CRITICAL 的告警数量
  - 在卡片右上角显示告警数量徽章
  - 告警数量 > 0 时，徽章高亮显示（红色或橙色）
  - 告警数量 = 0 时，不显示徽章或显示为灰色

#### Scenario: 告警数量实时更新

- **WHEN** alarms-store 接收到新的告警推送或告警状态变化
- **THEN** 系统必须(SHALL)：
  - 自动重新计算各系统的活跃告警数量
  - 更新对应系统健康卡片上的告警数量徽章
  - 整个更新过程在 500ms 内完成

---

### Requirement: 历史健康报告列表管理

系统必须(SHALL)在页面底部展示历史健康报告列表，支持分页浏览、报告生成和导出功能。

#### Scenario: 查询历史报告列表

- **WHEN** 用户访问健康评估页面或点击"查询"按钮
- **THEN** 系统必须(SHALL)：
  - 调用 `/api/reports/health` 接口获取历史报告列表
  - 显示加载状态（loading skeleton 或 spinner）
  - 接收到数据后，在表格中展示报告列表
  - 表格列包含：报告 ID、生成日期、涉及设备、健康评分、健康等级、操作按钮

#### Scenario: 历史报告分页浏览

- **WHEN** 用户点击分页控件（上一页/下一页/页码）
- **THEN** 系统必须(SHALL)：
  - 调用 API 请求对应页的报告数据
  - 显示加载状态
  - 更新表格内容和分页控件状态
  - 默认每页显示 10 条报告

#### Scenario: 生成新的健康报告

- **WHEN** 用户点击"生成新报告"按钮
- **THEN** 系统必须(SHALL)：
  - 弹出对话框或表单，让用户选择报告参数（设备 ID、时间范围）
  - 用户确认后，调用 `/api/reports/health` POST 接口生成报告
  - 显示加载状态和进度提示
  - 报告生成完成后，显示成功提示
  - 自动刷新历史报告列表，新报告出现在列表顶部

#### Scenario: 导出健康报告

- **WHEN** 用户点击报告列表中某个报告的"导出"按钮
- **THEN** 系统必须(SHALL)：
  - 调用报告导出 API，请求 PDF 格式的报告文件
  - 显示导出进度提示
  - 接收到下载链接后，打开新窗口或直接下载文件
  - 导出失败时，显示友好的错误提示

#### Scenario: 历史报告列表为空

- **WHEN** 查询历史报告列表，但返回结果为空
- **THEN** 系统必须(SHALL)：
  - 显示"暂无历史报告"提示信息
  - 提示用户可以点击"生成新报告"按钮创建第一份报告
  - 不显示空的表格

---

### Requirement: 错误处理和边界情况

系统必须(SHALL)妥善处理各种错误和边界情况，确保用户体验友好。

#### Scenario: WebSocket 连接断开

- **WHEN** WebSocket 连接断开或连接失败
- **THEN** 系统必须(SHALL)：
  - 在页面顶部显示"实时连接已断开"警告提示
  - 自动尝试重连（由 realtime-service 处理）
  - 重连成功后，移除警告提示并恢复实时数据订阅

#### Scenario: 健康数据获取失败

- **WHEN** 调用 API 获取健康数据失败（网络错误、服务器错误等）
- **THEN** 系统必须(SHALL)：
  - 在对应区域显示错误提示信息
  - 提供"重试"按钮，让用户手动重新请求
  - 记录错误日志（控制台或日志服务）
  - 不阻塞页面其他部分的正常显示

#### Scenario: 系统健康数据缺失

- **WHEN** 某个核心系统的健康数据暂时不可用
- **THEN** 系统必须(SHALL)：
  - 在对应的系统健康卡片上显示"暂无数据"或"未评估"状态
  - 卡片保持显示，但评分、趋势图等内容显示为占位符
  - 告警数量徽章仍然正常显示（如果有告警数据）

#### Scenario: 趋势数据不足

- **WHEN** 某个系统的趋势数据点 < 2
- **THEN** 系统必须(SHALL)：
  - 不显示 Sparkline 趋势图
  - 在趋势图位置显示"数据不足"提示
  - 其他卡片内容（评分、告警数量等）正常显示

---

### Requirement: 性能和用户体验

系统必须(SHALL)确保页面加载速度和交互响应速度满足性能要求，提供流畅的用户体验。

#### Scenario: 页面初始加载性能

- **WHEN** 用户首次访问健康评估页面
- **THEN** 系统必须(SHALL)：
  - 页面首屏渲染时间 < 2 秒
  - 健康数据获取和显示时间 < 3 秒
  - 显示友好的加载状态（skeleton 或 spinner）
  - 避免页面内容闪烁或布局跳动

#### Scenario: 实时数据更新响应速度

- **WHEN** 接收到 WebSocket 推送的健康数据更新
- **THEN** 系统必须(SHALL)：
  - UI 更新响应时间 < 500ms
  - 更新过程流畅，无明显卡顿
  - 使用 React.memo 和 useMemo 避免不必要的组件重渲染

#### Scenario: 系统健康卡片渲染优化

- **WHEN** 页面包含多个系统健康卡片（5+ 个）
- **THEN** 系统必须(SHALL)：
  - 使用 React.memo 包裹卡片组件，避免父组件更新时全部重渲染
  - Sparkline 趋势图使用懒加载或按需渲染
  - 整体渲染性能流畅，无明显延迟

---

## 总结

本规范增量定义了健康评估页面的核心功能需求，包括：
- "总-分-细"三段式页面布局
- 整船健康仪表盘展示
- 系统健康卡片矩阵展示和交互
- 实时健康数据更新和趋势可视化
- 跨 Store 数据聚合（健康状态 + 告警）
- 历史健康报告列表管理（查询、生成、导出）
- 错误处理和边界情况
- 性能和用户体验要求

这些需求共同构成了一个功能完善、体验流畅的健康评估页面，为管理者提供高级、可执行的全局健康概览。
