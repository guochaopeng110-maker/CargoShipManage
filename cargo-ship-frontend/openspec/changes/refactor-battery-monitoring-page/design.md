# 设计文档 - 重构电池监控页面

## Context（背景）

### 问题描述
当前项目已完成：
1. **第一阶段（数据层）**：`monitoring-store`、`alarms-store`、`realtime-service` 已就绪
2. **第二阶段（可视化组件）**：`MetricCard`、`MetricIcon` 等动画组件已完成

但缺少：
- 完整的页面级集成案例
- 统一的设备监控页模板
- 实际的订阅生命周期管理实践

### 技术约束
- **前端框架**: React 18 + TypeScript
- **状态管理**: Zustand (monitoring-store, alarms-store)
- **实时通信**: Socket.IO (realtime-service)
- **样式**: Tailwind CSS + Framer Motion 动画
- **架构原则**: 单一真理源、哑组件、数据驱动渲染

### 关键假设
- 电池系统设备 ID 为 `SYS-BAT-001`
- 电池系统有多个监测点（总电压、SOC、温度、电流等）
- 后端 WebSocket 支持 `subscribe:equipment` 和 `unsubscribe:equipment` 事件
- 告警数据可按 `equipmentId` 过滤

## Goals / Non-Goals（目标与非目标）

### Goals（目标）
1. **验证新架构的完整数据流**：
   - WebSocket 连接 → Service → Store → Component
   - 证明数据层和可视化层的无缝集成

2. **确立设备监控页模板**：
   - 提供清晰的目录结构和组件划分
   - 可复制到其他设备监控页（推进系统、逆变器等）

3. **实现"监控墙"概念**：
   - 响应式网格布局，完整展示所有监测点
   - 每个监测点使用独立的 `MetricCard` 组件

4. **专属告警区**：
   - 仅显示与当前设备相关的告警
   - 实时响应 `alarm:push` 事件

5. **生命周期管理**：
   - 正确处理订阅和取消订阅
   - 避免内存泄漏和重复订阅

### Non-Goals（非目标）
- ❌ 不修改现有的 `monitoring-store` 或 `alarms-store` 核心逻辑
- ❌ 不涉及后端 API 或数据库变更
- ❌ 不包含历史数据查询功能（仅实时数据）
- ❌ 不实现高级图表（如折线图、柱状图）

## Decisions（技术决策）

### 决策 1: 组件拆分策略
**决策**: 将页面拆分为三个独立组件

**理由**:
- **BatteryMonitoringPage**: 顶层容器，负责订阅生命周期管理
- **MonitoringWall**: 监控墙，负责网格布局和 MetricCard 渲染
- **DedicatedAlarmZone**: 告警区，负责告警列表展示

**优势**:
- 职责单一，易于维护和测试
- 组件可复用到其他设备监控页
- 清晰的依赖关系

### 决策 2: 数据获取方式
**决策**: 使用 Zustand Store Selectors

**备选方案**:
- 方案 A: 在组件内部直接调用 API 或 Service
- 方案 B: 使用 React Context 传递数据
- **方案 C (选择): 直接从 Zustand Store 订阅数据**

**选择理由**:
- 符合新架构的"单一真理源"原则
- 自动响应数据变化，无需手动刷新
- 性能优秀（Zustand 内置优化）
- 代码简洁，减少样板代码

### 决策 3: 订阅生命周期管理
**决策**: 在 `BatteryMonitoringPage` 的 `useEffect` 中管理订阅

```typescript
useEffect(() => {
  // 挂载时订阅
  realtimeService.subscribeToEquipment('SYS-BAT-001');

  // 卸载时取消订阅
  return () => {
    realtimeService.unsubscribeFromEquipment('SYS-BAT-001');
  };
}, []);
```

**理由**:
- 自动处理组件生命周期
- 避免内存泄漏
- 符合 React Hooks 最佳实践

### 决策 4: 监控墙布局
**决策**: 使用 CSS Grid + 响应式断点

**布局方案**:
- **桌面端 (≥1024px)**: 4列网格
- **平板端 (768px - 1023px)**: 2列网格
- **手机端 (<768px)**: 1列网格

**理由**:
- CSS Grid 天然支持响应式布局
- Tailwind 提供简洁的响应式工具类
- 易于调整和维护

### 决策 5: 告警过滤逻辑
**决策**: 在组件内部使用 `useMemo` 过滤告警

```typescript
const batteryAlarms = useMemo(() =>
  allAlarms.filter(alarm => alarm.equipmentId === 'SYS-BAT-001'),
  [allAlarms]
);
```

**备选方案**:
- 方案 A: 在 `alarms-store` 中添加设备过滤方法
- **方案 B (选择): 在组件内部使用 `useMemo` 过滤**

**选择理由**:
- 不修改现有 Store 逻辑（遵循 Non-Goals）
- `useMemo` 保证性能（仅在 allAlarms 变化时重新计算）
- 灵活，不同页面可以有不同的过滤逻辑

### 决策 6: 错误处理策略
**决策**: 在页面级组件显示错误提示

**方案**:
- 从 `monitoring-store` 和 `alarms-store` 读取 `error` 状态
- 使用 `sonner` Toast 或内联错误提示显示错误信息
- 提供重试机制（如"重新连接"按钮）

**理由**:
- 用户友好，及时反馈错误
- 不影响其他功能模块
- 符合项目的错误处理模式

### 决策 7: 多设备监控支持（新增）
**决策**: 组件设计支持多设备扩展，优先实现单设备场景

**方案**:
- **第一阶段（当前提案）**: 实现单设备电池监控页面
  - `MonitoringWall` 接收单个 `equipmentId`
  - `DedicatedAlarmZone` 接收单个 `equipmentId`

- **第二阶段（后续优化）**: 扩展支持多设备场景
  - `MonitoringWall` 添加可选的 `title` 和 `columnCount` props
  - `DedicatedAlarmZone` 支持 `equipmentIds` 数组和 `groupByEquipment` 选项
  - 创建 `PropulsionMonitoringPage` 作为多设备页面示例

**接口设计（向后兼容）**:
```typescript
// MonitoringWall.tsx - 支持单设备和多设备场景
interface MonitoringWallProps {
  equipmentId: string;                      // 必需：设备ID
  title?: string;                           // 可选：显示标题（多设备场景需要）
  columnCount?: {                           // 可选：自定义列数
    desktop?: number;                       // 默认: 4
    tablet?: number;                        // 默认: 2
    mobile?: number;                        // 默认: 1
  };
  className?: string;                       // 可选：自定义CSS类
}

// DedicatedAlarmZone.tsx - 支持单设备和多设备场景
interface DedicatedAlarmZoneProps {
  equipmentIds: string | string[];         // 单个或多个设备ID
  groupByEquipment?: boolean;              // 可选：是否按设备分组（多设备场景）
  maxItems?: number;                       // 可选：最大显示数量（默认20）
  className?: string;                      // 可选：自定义CSS类
}
```

**选择理由**:
- 符合"简单优先"原则，先实现单设备场景
- 接口设计具有前瞻性，易于扩展
- 向后兼容，不影响已有单设备页面
- 为推进系统等多设备场景铺平道路

## Risks / Trade-offs（风险与权衡）

### 风险 1: 高频数据更新可能导致性能问题
**风险**: 如果电池系统有 20+ 监测点，每个每秒更新一次，可能导致频繁重渲染

**缓解措施**:
- 使用 `React.memo` 优化 `MetricCard`
- 使用 Zustand Selectors 仅订阅需要的数据
- `monitoring-store` 已实现批量更新机制（每秒批量处理一次）

**权衡**:
- 接受轻微的数据延迟（最多1秒）以换取性能

### 风险 2: WebSocket 连接断开导致数据丢失
**风险**: 网络不稳定时，WebSocket 断开可能导致监控数据缺失

**缓解措施**:
- `realtime-service` 已实现自动重连和重订阅
- 显示连接状态指示器（使用现有的 `ConnectionStatusIndicator`）
- 在断线期间显示"连接中断"提示

**权衡**:
- 不实现离线数据缓存（属于 Non-Goals）

### 风险 3: 组件复用到其他设备页面时需要修改设备 ID
**风险**: `BatteryMonitoringPage` 硬编码了 `SYS-BAT-001`，复用时容易遗忘修改

**缓解措施**:
- 在 README 文档中明确说明复用步骤
- 考虑后续优化：提取 `BaseMonitoringPage` 组件，接收 `equipmentId` 作为 prop

**权衡**:
- 当前阶段优先快速实现，后续重构为通用组件

## Migration Plan（迁移计划）

### 步骤 1: 开发新页面（不影响现有功能）
- 新建文件，不修改现有代码
- 在开发环境测试

### 步骤 2: 添加路由（可选功能）
- 添加 `/monitoring/battery` 路由
- 在侧边栏添加"电池监控"菜单项（可通过配置控制显示/隐藏）

### 步骤 3: 并行运行（如果有旧页面）
- 新旧页面并存一段时间
- 收集用户反馈

### 步骤 4: 完全切换
- 确认新页面稳定后，移除旧页面（如果存在）
- 更新文档

### Rollback（回滚策略）
- 如果发现严重问题，删除新路由即可
- 不影响现有功能模块

## Open Questions（待解决问题）

### Q1: 电池系统的监测点列表从哪里获取？
**现状**: 需要确认 `SYS-BAT-001` 的所有监测点

**选项**:
- A: 从后端 API 获取动态列表
- B: 在前端硬编码（基于设备配置文档）
- C: 从 `monitoring-store` 的数据推断（根据已接收的数据）

**建议**: 优先选项 B（硬编码），便于快速实现；后续优化为选项 A

### Q2: 告警区是否需要分页？
**现状**: 如果告警数量很多（100+ 条），可能需要分页或虚拟滚动

**建议**:
- 第一版仅显示最近 20 条告警
- 提供"查看全部"按钮跳转到告警中心页面

### Q3: 是否需要支持监测点的手动刷新？
**现状**: 当前设计是完全自动实时更新

**建议**:
- 不需要手动刷新（违背实时监控的初衷）
- 如果 WebSocket 断开，显示"重新连接"按钮

### Q4: 多设备监控场景如何布局？（新增）
**场景**: 推进系统有左推进系统（SYS-PROP-L-001）和右推进系统（SYS-PROP-R-001），两者监测点相同，但需要同时监控

**方案对比**:

#### 方案 A: 标签页切换（Tab Switching）
**布局**: 使用 Tab 组件，每个 Tab 对应一个设备
```
[ 左推进系统 ] | [ 右推进系统 ]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[  监控墙 - 左推进系统  ]
[  专属告警区 - 左推进系统  ]
```

**优势**:
- 页面结构清晰，不拥挤
- 每个设备独立订阅，性能开销小
- 易于实现（复用现有组件）

**劣势**:
- 无法同时对比两个设备的数据
- 需要手动切换才能查看另一个设备

**适用场景**: 设备差异大，或只需单独监控

---

#### 方案 B: 左右分栏布局（Side-by-Side Layout）⭐ 推荐
**布局**: 使用两列布局，左右各显示一个设备的监控墙
```
┌──────────────────┬──────────────────┐
│  左推进系统      │  右推进系统      │
│  [监控墙]        │  [监控墙]        │
│                  │                  │
└──────────────────┴──────────────────┘
      [统一告警区 - 显示两个设备的告警]
```

**优势**:
- ✅ 可同时对比两个设备的实时数据
- ✅ 符合对称设备的直觉（左右推进）
- ✅ 易于发现异常（对比差异）

**劣势**:
- 在小屏幕（平板/手机）上需要切换为垂直堆叠
- 单个监控墙的宽度减半，可能需要调整卡片大小

**适用场景**: ⭐ **推荐用于对称设备（左右推进、双电池组等）**

**响应式策略**:
- 桌面端（≥1024px）: 左右分栏，每栏 2 列网格
- 平板端（768px - 1023px）: 垂直堆叠，每个监控墙 2 列网格
- 手机端（<768px）: 垂直堆叠或 Tab 切换，1 列网格

---

#### 方案 C: 垂直堆叠布局（Vertical Stacking）
**布局**: 上下堆叠两个完整的监控墙
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  左推进系统 - 监控墙
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  左推进系统 - 专属告警区
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  右推进系统 - 监控墙
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  右推进系统 - 专属告警区
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**优势**:
- 每个设备都有完整的展示空间
- 在所有屏幕尺寸上保持一致

**劣势**:
- 页面很长，需要滚动
- 难以快速对比两个设备的数据

**适用场景**: 设备数量少（2-3个），且需要完整展示每个设备

---

#### 方案 D: 统一网格 + 设备标识（Unified Grid）
**布局**: 在一个监控墙中显示所有监测点，每个 MetricCard 标注所属设备
```
┌─────────────────────────────────┐
│  [左-总电压] [右-总电压]        │
│  [左-SOC]    [右-SOC]           │
│  [左-电流]   [右-电流]          │
│  [左-温度]   [右-温度]          │
└─────────────────────────────────┘
```

**优势**:
- 相同监测点并排显示，便于对比
- 页面结构紧凑

**劣势**:
- 需要修改 MetricCard 组件，添加设备标识
- 告警区难以区分设备
- 扩展性差（如果监测点不完全相同）

**适用场景**: 监测点完全相同且数量少（<10个）

---

**最终建议**:

**对于推进系统（左右对称）场景**:
- ✅ **优先选择方案 B（左右分栏布局）**
- 理由：
  1. 符合"左右推进"的物理直觉
  2. 便于实时对比两侧数据
  3. 易于发现不对称的异常情况
  4. 响应式设计可兼顾小屏幕

**实现细节**:
```typescript
// PropulsionMonitoringPage.tsx
<div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
  {/* 左推进系统监控墙 */}
  <MonitoringWall
    title="左推进系统"
    equipmentId="SYS-PROP-L-001"
    columnCount={{ desktop: 2, tablet: 2, mobile: 1 }}
  />

  {/* 右推进系统监控墙 */}
  <MonitoringWall
    title="右推进系统"
    equipmentId="SYS-PROP-R-001"
    columnCount={{ desktop: 2, tablet: 2, mobile: 1 }}
  />
</div>

{/* 统一告警区（显示两个设备的告警） */}
<DedicatedAlarmZone
  equipmentIds={['SYS-PROP-L-001', 'SYS-PROP-R-001']}
  groupByEquipment={true}
/>
```

**对于其他场景**:
- 如果设备数量 > 2（如4个电池组）: 使用 **方案 A（标签页切换）**
- 如果设备监测点完全不同: 使用 **方案 A（标签页切换）**
- 如果只有1个设备: 使用 **当前电池监控页的设计**（全宽监控墙）

## Summary（总结）

本设计方案：
1. ✅ 充分利用现有的数据层和可视化组件
2. ✅ 确立清晰的组件拆分和职责划分
3. ✅ 遵循项目的架构原则和技术栈
4. ✅ 提供可复用的设备监控页模板
5. ✅ 考虑了性能、错误处理和用户体验
6. ✅ 组件接口设计具有前瞻性，支持未来多设备扩展

**第一阶段成果（当前提案）**:
- 实现单设备电池监控页面（`BatteryMonitoringPage`）
- 验证新架构的完整数据流
- 确立设备监控页的标准模板

**第二阶段扩展（后续优化）**:
- 基于电池监控页模板，实现推进系统等多设备监控页
- 使用左右分栏布局（方案 B）便于对比两侧设备数据
- 组件接口向后兼容，无需重写已有单设备页面

实施后将成为其他设备监控页的标准参考。
