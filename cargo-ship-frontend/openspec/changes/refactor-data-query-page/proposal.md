# 重构数据查询页面：聚焦表格的简洁查询工具

## 概述

将 DataQueryPage 重构为一个以数据表格为中心的、简洁高效的工具。新设计将彻底简化UI，并为用户发起的、基于REST API的、分页的历史数据查询建立一个清晰、标准的数据流模式。

## 问题陈述

### 当前痛点

当前的 DataQueryPage 存在以下问题：

1. **UI过于复杂**
   - 包含多个 Tabs（图表、表格、统计、历史）
   - 集成了多种图表类型（折线图、柱状图、饼图）
   - 高级选项（时间粒度、聚合类型）增加了用户认知负担

2. **功能定位不清晰**
   - 将数据可视化和数据查询混杂在一起
   - 用户主要目的是查询和导出数据，但界面被图表占据大量空间

3. **数据流模式不统一**
   - 当前使用 `createQuery` 和 `executeQuery` 的复杂机制
   - 需要建立清晰的"用户驱动的API请求"模式
   - 与实时监控页面的数据流应有明确区分

4. **缺少可复用的模式**
   - 其他模块（如历史告警查询、操作日志查询）也需要类似的"筛选-分页列表"功能
   - 当前实现无法作为标准模板复用

### 用户需求

用户期望的数据查询页面应该：

1. **简洁直观**：聚焦于核心查询功能，移除所有干扰元素
2. **快速响应**：明确的查询触发机制，清晰的加载状态
3. **易于导出**：方便的数据导出功能（Excel, CSV, JSON）
4. **分页浏览**：支持大量历史数据的分页查看

## 目标

### 主要目标

1. **简化UI/UX**
   - 页面简化为"查询条件区"和"结果展示区"两部分
   - 移除所有图表、Tabs等与核心查询功能无关的组件
   - 精简筛选条件为三个核心控件：设备选择、监控参数、日期范围

2. **建立标准数据流**
   - 实现清晰的"用户驱动的API请求"模式
   - 基于 api-client 的请求-响应机制
   - 在 monitoring-store 中扩展历史查询相关状态管理

3. **提升用户体验**
   - 提供日期范围选择器和快捷选项（如"最近7天"）
   - 独立的 Pagination 分页组件
   - 清晰的加载状态和错误提示

4. **建立可复用模式**
   - 确立标准的"筛选-分页列表"页面开发模式
   - 供其他模块（如历史告警查询、操作日志查询）复用

### 非目标

以下内容不在本次重构范围内：

- 数据可视化功能（图表、统计分析等应该在专门的数据分析页面实现）
- 高级查询功能（如复杂的聚合、时间粒度控制等）
- 查询历史管理（后续可作为独立功能实现）

## 解决方案

### 核心设计原则

1. **聚焦表格** (Table-Centric Design)
   - 整个页面以数据表格为核心
   - 所有功能都围绕"查询-展示-导出"这一主线

2. **用户驱动** (User-Initiated)
   - 所有数据请求由用户主动触发
   - 明确的"执行查询"按钮
   - 清晰的加载和错误状态反馈

3. **简洁高效** (Simple and Efficient)
   - 最小化UI元素
   - 快速的查询响应
   - 流畅的交互体验

### 关键变更

#### 1. UI/UX 重构

**查询条件区**
- 设备选择（单选下拉框）
- 监控参数（多选按钮组）
- 日期范围选择器（带快捷选项：最近7天、最近30天等）
- 执行查询按钮

**结果展示区**
- 数据表格（展示查询结果）
- 分页组件（页码、总页数、页面跳转）

**功能操作区**
- 数据导出按钮（Excel, CSV, JSON）

#### 2. 数据流重构

**触发流程**
```
用户配置筛选条件 → 点击"执行查询" → 调用 Store Action → API 请求 → 更新 Store 状态 → UI 响应
```

**Store 扩展**
在 monitoring-store 中添加：
```typescript
historicalData: {
  items: UnifiedMonitoringData[]
  total: number
  page: number
  pageSize: number
}
queryStatus: 'idle' | 'loading' | 'success' | 'error'
```

**Action 设计**
```typescript
fetchHistoricalData(filters: {
  deviceId: string
  metricTypes: string[]
  startTime: number
  endTime: number
  page: number
  pageSize: number
})
```

#### 3. 技术实现要点

1. **日期范围选择器**
   - 使用标准的 Date Range Picker 组件
   - 提供快捷选项（最近7天、最近30天、本月、上月等）
   - 自动转换为时间戳传给后端

2. **分页组件**
   - 独立的 Pagination 组件
   - 支持页码显示、总页数、页面跳转
   - 与 Store 的 historicalData 状态双向绑定

3. **数据导出**
   - 保留现有的导出功能
   - 支持 Excel, CSV, JSON 三种格式

## 影响范围

### 受影响的文件

#### 需要重构
- `src/components/DataQueryPage.tsx` - 完全重构UI和逻辑
- `src/stores/monitoring-store.ts` - 扩展历史查询状态和 actions

#### 可能需要创建
- `src/components/ui/date-range-picker.tsx` - 日期范围选择器组件
- `src/components/ui/pagination.tsx` - 分页组件（如果不存在）

#### 需要更新
- `src/services/api-client.ts` - 确保支持历史数据查询的 API 端点

### 受影响的用户工作流

1. **数据查询工作流**
   - 用户将获得更简洁、直观的查询体验
   - 查询条件更加明确，减少选择困扰

2. **数据导出工作流**
   - 保持不变，用户可以继续使用现有的导出功能

## 预期成果

### 用户体验提升

1. **更简单的界面**
   - 页面加载更快
   - 用户能够快速找到所需功能
   - 减少认知负担

2. **更直观的交互**
   - 明确的查询触发机制
   - 清晰的加载和错误状态
   - 流畅的分页浏览体验

3. **更快的响应**
   - 精简的 API 请求
   - 优化的数据渲染

### 技术架构提升

1. **清晰的数据流**
   - 用户驱动的 API 请求模式明确
   - Store 状态管理职责清晰
   - 与实时监控的数据流有明确区分

2. **可复用的模式**
   - 建立标准的"筛选-分页列表"页面模板
   - 其他模块可以复用这一模式
   - 减少未来开发成本

3. **更好的可维护性**
   - 代码结构更加清晰
   - 职责分离更加明确
   - 更容易测试和调试

## 成功指标

1. **代码简化**
   - DataQueryPage 代码行数减少至少 30%
   - UI 组件层级减少

2. **性能提升**
   - 页面首次渲染时间减少
   - 查询响应时间优化

3. **用户反馈**
   - 用户能够快速完成数据查询任务
   - 减少用户困惑和支持请求

## 风险与缓解

### 风险

1. **功能缺失感**
   - 移除图表和统计功能可能让部分用户感到功能减少
   - **缓解**：在文档中明确说明数据可视化应在专门的分析页面实现

2. **API 支持不足**
   - 后端 API 可能不完全支持新的查询模式
   - **缓解**：在实施前与后端团队确认 API 能力，必要时先完成 API 开发

3. **状态管理复杂度**
   - Store 同时管理实时数据和历史数据可能增加复杂度
   - **缓解**：清晰划分状态，使用明确的命名和注释

## 替代方案

### 方案 A：渐进式重构
- 保留现有功能，仅优化 UI
- **缺点**：无法解决核心问题，技术债继续累积

### 方案 B：创建新页面
- 创建全新的简化查询页面，保留旧页面
- **缺点**：维护两套代码，用户困惑

### 推荐方案：彻底重构（本提案）
- 一次性解决所有问题
- 建立清晰的技术架构
- **优点**：长期收益最大，技术债清零

## 实施计划概览

本次重构将分为以下阶段实施：

1. **准备阶段**
   - 创建或更新 UI 组件（DateRangePicker, Pagination）
   - 扩展 monitoring-store 的状态和 actions

2. **核心重构阶段**
   - 重构 DataQueryPage UI
   - 实现新的数据流逻辑
   - 集成分页功能

3. **测试和优化阶段**
   - 功能测试
   - 性能优化
   - UI/UX 调优

4. **文档和交付阶段**
   - 更新用户文档
   - 代码审查
   - 部署上线

详细的任务分解请参见 `tasks.md`。

## 依赖关系

### 前置依赖
- 无特殊前置依赖
- 可以独立实施

### 后续工作
- 基于本次建立的模式，重构其他类似页面（如历史告警查询、操作日志查询）
- 在专门的数据分析页面实现高级可视化功能

## 相关文档

- [设计文档](./design.md) - 详细的技术设计和架构说明
- [任务列表](./tasks.md) - 详细的实施任务分解
- [规范变更](./specs/) - 相关的规范增量文件

## 审批和反馈

请审阅本提案并提供反馈：

- [ ] 是否同意整体方向？
- [ ] 是否有遗漏的关键需求？
- [ ] 是否有更好的替代方案？
- [ ] 实施计划是否合理？

---

**提案作者**: AI Assistant
**创建日期**: 2025-12-14
**最后更新**: 2025-12-14
**状态**: 待审批
