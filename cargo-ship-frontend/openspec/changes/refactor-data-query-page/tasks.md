# 数据查询页面重构 - 任务列表

本文档详细列出了重构 DataQueryPage 的所有任务，按阶段和优先级组织。每个任务都包含明确的验收标准。

## 任务概览

- **总任务数**: 24
- **预计工时**: 约 3-4 个工作日
- **依赖关系**: 部分任务可并行，部分需顺序执行

## 状态说明

- `[ ]` - 待开始 (Pending)
- `[~]` - 进行中 (In Progress)
- `[x]` - 已完成 (Completed)
- `[!]` - 已阻塞 (Blocked)

---

## 阶段 1: 准备工作 (Foundation)

### 1.1 创建或检查 DateRangePicker 组件

**状态**: `[x]`

**描述**: 检查项目中是否已有 DateRangePicker 组件，如果没有则创建一个新的。

**任务**:
- [ ] 在 `src/components/ui/` 目录下搜索现有的日期选择组件
- [ ] 如果不存在，创建 `src/components/ui/date-range-picker.tsx`
- [ ] 实现基本的日期范围选择功能
- [ ] 添加快捷选项（最近7天、最近30天、本月、上月）
- [ ] 实现日期范围验证（开始时间不能晚于结束时间）

**验收标准**:
- [ ] 组件可以正常渲染
- [ ] 用户可以选择起止日期
- [ ] 快捷选项可以正常工作
- [ ] 日期范围验证正常
- [ ] 组件符合项目 UI 设计规范

**依赖**: 无

**预计工时**: 3-4 小时

---

### 1.2 创建或检查 Pagination 组件

**状态**: `[x]`

**描述**: 检查项目中是否已有 Pagination 组件，如果没有则创建一个新的。

**任务**:
- [ ] 在 `src/components/ui/` 目录下搜索现有的分页组件
- [ ] 如果不存在，创建 `src/components/ui/pagination.tsx`
- [ ] 实现页码显示和页面跳转功能
- [ ] 添加上一页/下一页按钮
- [ ] 添加总页数和总数据量显示
- [ ] 实现页码省略显示（当页数过多时）

**验收标准**:
- [ ] 组件可以正常渲染
- [ ] 页码跳转功能正常
- [ ] 上一页/下一页按钮功能正常
- [ ] 边界情况处理正确（第一页、最后一页）
- [ ] 组件符合项目 UI 设计规范

**依赖**: 无

**预计工时**: 2-3 小时

---

### 1.3 扩展 monitoring-store 状态定义

**状态**: `[x]`

**描述**: 在 monitoring-store 中添加历史查询相关的状态定义。

**任务**:
- [ ] 打开 `src/stores/monitoring-store.ts`
- [ ] 在 `MonitoringState` 接口中添加以下状态：
  ```typescript
  historicalData: {
    items: UnifiedMonitoringData[];
    total: number;
    page: number;
    pageSize: number;
    totalPages: number;
  };
  queryStatus: 'idle' | 'loading' | 'success' | 'error';
  queryError: string | null;
  currentQueryParams: HistoricalQueryParams | null;
  ```
- [ ] 定义 `HistoricalQueryParams` 接口
- [ ] 初始化新增状态的默认值

**验收标准**:
- [ ] TypeScript 编译无错误
- [ ] 状态类型定义完整
- [ ] 默认值设置合理
- [ ] 符合现有 store 的代码风格

**依赖**: 无

**预计工时**: 1 小时

---

### 1.4 实现 fetchHistoricalData Action

**状态**: `[x]`

**描述**: 在 monitoring-store 中实现获取历史数据的 action。

**任务**:
- [ ] 在 `MonitoringActions` 接口中声明 `fetchHistoricalData` 方法
- [ ] 实现该方法的业务逻辑：
  - [ ] 设置 queryStatus 为 'loading'
  - [ ] 保存 currentQueryParams
  - [ ] 调用 API 获取数据
  - [ ] 更新 historicalData 状态
  - [ ] 处理成功和失败情况
- [ ] 添加错误处理和日志记录

**验收标准**:
- [ ] 方法可以正常调用
- [ ] 状态更新逻辑正确
- [ ] 错误处理完善
- [ ] API 调用正常
- [ ] 有适当的日志输出

**依赖**: 任务 1.3

**预计工时**: 2-3 小时

---

### 1.5 实现 exportHistoricalData Action

**状态**: `[x]`

**描述**: 在 monitoring-store 中实现导出历史数据的 action。

**任务**:
- [ ] 在 `MonitoringActions` 接口中声明 `exportHistoricalData` 方法
- [ ] 实现该方法的业务逻辑：
  - [ ] 验证是否有可导出的数据
  - [ ] 调用导出 API
  - [ ] 处理下载链接或文件流
  - [ ] 触发浏览器下载
- [ ] 添加错误处理

**验收标准**:
- [ ] 方法可以正常调用
- [ ] 支持 Excel、CSV、JSON 三种格式
- [ ] 文件下载功能正常
- [ ] 错误处理完善

**依赖**: 任务 1.3

**预计工时**: 2 小时

---

### 1.6 添加辅助 Actions

**状态**: `[x]`

**描述**: 实现一些辅助性的 actions。

**任务**:
- [ ] 实现 `clearHistoricalData` - 清除查询结果
- [ ] 实现 `resetQueryStatus` - 重置查询状态

**验收标准**:
- [ ] 所有辅助方法功能正常
- [ ] 状态重置逻辑正确

**依赖**: 任务 1.3

**预计工时**: 0.5 小时

---

## 阶段 2: 核心重构 (Core Refactoring)

### 2.1 创建 QueryFilters 子组件

**状态**: `[x]`

**描述**: 创建查询条件区域的独立组件。

**任务**:
- [ ] 创建 `src/components/DataQueryPage/QueryFilters.tsx`
- [ ] 实现设备选择下拉框
- [ ] 实现监控参数多选按钮组
- [ ] 集成 DateRangePicker 组件
- [ ] 添加"执行查询"按钮
- [ ] 实现表单验证逻辑

**验收标准**:
- [ ] 组件可以独立渲染
- [ ] 所有表单控件功能正常
- [ ] 表单验证逻辑正确
- [ ] Props 接口设计合理
- [ ] 符合 UI 设计规范

**依赖**: 任务 1.1

**预计工时**: 3-4 小时

---

### 2.2 创建 QueryResults 子组件

**状态**: `[x]`

**描述**: 创建查询结果展示区域的独立组件。

**任务**:
- [ ] 创建 `src/components/DataQueryPage/QueryResults.tsx`
- [ ] 实现数据表格展示
- [ ] 集成 Pagination 组件
- [ ] 添加导出按钮组
- [ ] 实现加载状态展示
- [ ] 实现空状态和错误状态展示

**验收标准**:
- [ ] 组件可以独立渲染
- [ ] 表格数据展示正常
- [ ] 分页功能正常
- [ ] 导出按钮功能正常
- [ ] 各种状态展示正确

**依赖**: 任务 1.2

**预计工时**: 4-5 小时

---

### 2.3 重构 DataQueryPage 主组件

**状态**: `[x]`

**描述**: 重构 DataQueryPage.tsx，使用新的组件结构和数据流。

**任务**:
- [ ] 备份当前的 DataQueryPage.tsx
- [ ] 移除所有旧的 UI 代码（Tabs、图表等）
- [ ] 集成 QueryFilters 组件
- [ ] 集成 QueryResults 组件
- [ ] 实现新的数据流逻辑
- [ ] 连接 monitoring-store 的新 actions
- [ ] 移除不再需要的状态和逻辑

**验收标准**:
- [ ] 页面可以正常渲染
- [ ] 所有功能正常工作
- [ ] 代码行数明显减少
- [ ] 代码结构清晰
- [ ] 无 TypeScript 错误

**依赖**: 任务 2.1, 2.2, 1.4, 1.5

**预计工时**: 3-4 小时

---

### 2.4 实现查询触发逻辑

**状态**: `[x]`

**描述**: 实现用户点击"执行查询"按钮后的完整流程。

**任务**:
- [ ] 在 DataQueryPage 中实现 `handleExecuteQuery` 方法
- [ ] 添加表单验证逻辑
- [ ] 调用 store 的 `fetchHistoricalData` action
- [ ] 处理查询成功和失败情况
- [ ] 添加用户反馈（Toast 提示等）

**验收标准**:
- [ ] 点击查询按钮可以触发 API 请求
- [ ] 表单验证正常工作
- [ ] 数据可以正常展示
- [ ] 错误情况有合适的提示

**依赖**: 任务 2.3

**预计工时**: 2 小时

---

### 2.5 实现分页切换逻辑

**状态**: `[x]`

**描述**: 实现用户切换页码时的逻辑。

**任务**:
- [ ] 在 DataQueryPage 中实现 `handlePageChange` 方法
- [ ] 更新当前页码状态
- [ ] 使用新页码重新调用 `fetchHistoricalData`
- [ ] 保持其他查询参数不变

**验收标准**:
- [ ] 页码切换功能正常
- [ ] 数据可以正确加载
- [ ] 查询参数保持一致

**依赖**: 任务 2.4

**预计工时**: 1 小时

---

### 2.6 实现数据导出逻辑

**状态**: `[x]`

**描述**: 实现用户点击导出按钮的逻辑。

**任务**:
- [ ] 在 DataQueryPage 中实现 `handleExport` 方法
- [ ] 调用 store 的 `exportHistoricalData` action
- [ ] 处理各种格式的导出
- [ ] 添加导出进度指示
- [ ] 处理导出成功和失败情况

**验收标准**:
- [ ] Excel 导出功能正常
- [ ] CSV 导出功能正常
- [ ] JSON 导出功能正常
- [ ] 有导出进度提示
- [ ] 错误处理完善

**依赖**: 任务 2.3, 1.5

**预计工时**: 2 小时

---

## 阶段 3: UI/UX 优化 (Polishing)

### 3.1 优化加载状态展示

**状态**: `[x]`

**描述**: 改进页面各种加载状态的用户体验。

**任务**:
- [ ] 在查询时禁用"执行查询"按钮
- [ ] 在按钮上显示加载动画
- [ ] 在表格区域显示骨架屏或加载指示器
- [ ] 禁用分页控件（加载时）
- [ ] 添加加载时间提示

**验收标准**:
- [ ] 加载状态展示清晰
- [ ] 用户不会重复触发查询
- [ ] 加载动画流畅
- [ ] 符合 UI 设计规范

**依赖**: 任务 2.3

**预计工时**: 2 小时

---

### 3.2 优化错误状态展示

**状态**: `[x]`

**描述**: 改进错误提示的用户体验。

**任务**:
- [ ] 设计统一的错误展示组件
- [ ] 区分不同类型的错误（验证、网络、业务、服务器）
- [ ] 为每种错误提供合适的提示和操作
- [ ] 添加"重试"按钮
- [ ] 保留查询条件供用户调整

**验收标准**:
- [ ] 错误提示清晰易懂
- [ ] 不同错误有不同的展示
- [ ] 重试功能正常
- [ ] 用户可以方便地调整条件

**依赖**: 任务 2.3

**预计工时**: 2 小时

---

### 3.3 优化空结果状态展示

**状态**: `[x]`

**描述**: 改进无数据时的用户体验。

**任务**:
- [ ] 设计空状态展示组件
- [ ] 添加友好的提示文案
- [ ] 提供调整查询条件的建议
- [ ] 添加合适的图标或插图

**验收标准**:
- [ ] 空状态展示友好
- [ ] 文案清晰有帮助
- [ ] 符合 UI 设计规范

**依赖**: 任务 2.3

**预计工时**: 1 小时

---

### 3.4 优化表格展示

**状态**: `[x]`

**描述**: 改进数据表格的展示效果。

**任务**:
- [ ] 优化表格列宽和自适应
- [ ] 添加表格行悬停效果
- [ ] 优化单元格内容展示（长文本省略等）
- [ ] 添加状态徽章的样式
- [ ] 优化移动端展示（响应式）

**验收标准**:
- [ ] 表格展示美观
- [ ] 数据易于阅读
- [ ] 响应式布局正常
- [ ] 符合 UI 设计规范

**依赖**: 任务 2.2

**预计工时**: 2 小时

---

### 3.5 添加快捷键支持

**状态**: `[x]`

**描述**: 为页面添加键盘快捷键支持。

**任务**:
- [ ] Enter 键触发查询
- [ ] Esc 键清除错误提示
- [ ] 左/右箭头键切换页码
- [ ] 添加快捷键提示

**验收标准**:
- [ ] 快捷键功能正常
- [ ] 不干扰正常的表单输入
- [ ] 有快捷键提示

**依赖**: 任务 2.3

**预计工时**: 1 小时

---

## 阶段 4: 测试和验证 (Testing)

### 4.1 编写 Store Actions 单元测试

**状态**: `[ ]`

**描述**: 为新增的 store actions 编写单元测试。

**任务**:
- [ ] 测试 `fetchHistoricalData` 的成功场景
- [ ] 测试 `fetchHistoricalData` 的失败场景
- [ ] 测试 `exportHistoricalData` 的各种格式
- [ ] 测试状态更新逻辑
- [ ] 测试辅助 actions

**验收标准**:
- [ ] 测试覆盖率 > 80%
- [ ] 所有测试通过
- [ ] 测试案例全面

**依赖**: 任务 1.4, 1.5, 1.6

**预计工时**: 3 小时

---

### 4.2 编写组件单元测试

**状态**: `[ ]`

**描述**: 为新创建的组件编写单元测试。

**任务**:
- [ ] 测试 DateRangePicker 的日期选择和验证
- [ ] 测试 Pagination 的页码计算和跳转
- [ ] 测试 QueryFilters 的表单验证
- [ ] 测试 QueryResults 的数据展示

**验收标准**:
- [ ] 测试覆盖率 > 80%
- [ ] 所有测试通过
- [ ] 测试案例全面

**依赖**: 任务 1.1, 1.2, 2.1, 2.2

**预计工时**: 4 小时

---

### 4.3 进行集成测试

**状态**: `[ ]`

**描述**: 测试完整的数据流和用户工作流。

**任务**:
- [ ] 测试完整的查询流程
- [ ] 测试分页切换流程
- [ ] 测试数据导出流程
- [ ] 测试各种错误场景
- [ ] 测试边界情况

**验收标准**:
- [ ] 所有集成测试通过
- [ ] 各种场景覆盖全面

**依赖**: 任务 2.3, 2.4, 2.5, 2.6

**预计工时**: 3 小时

---

### 4.4 进行手动测试和 QA

**状态**: `[ ]`

**描述**: 进行全面的手动测试和质量保证。

**任务**:
- [ ] 测试所有用户工作流
- [ ] 测试不同浏览器的兼容性
- [ ] 测试不同屏幕尺寸的响应式布局
- [ ] 测试性能（加载时间、渲染流畅度）
- [ ] 检查 UI/UX 细节

**验收标准**:
- [ ] 所有功能正常工作
- [ ] 主流浏览器兼容
- [ ] 响应式布局正常
- [ ] 性能符合要求
- [ ] UI/UX 符合设计规范

**依赖**: 阶段 3 所有任务

**预计工时**: 4 小时

---

## 阶段 5: 优化和清理 (Optimization & Cleanup)

### 5.1 代码优化和重构

**状态**: `[x]`

**描述**: 优化代码质量和性能。

**任务**:
- [ ] 检查并优化性能瓶颈
- [ ] 添加 React.memo 优化不必要的重渲染
- [ ] 优化数据转换逻辑
- [ ] 检查并修复 TypeScript 类型问题
- [ ] 统一代码风格

**验收标准**:
- [ ] 无性能问题
- [ ] 无 TypeScript 错误或警告
- [ ] 代码符合团队规范

**依赖**: 阶段 4 所有任务

**预计工时**: 3 小时

---

### 5.2 移除废弃代码

**状态**: `[x]`

**描述**: 清理不再需要的代码和依赖。

**任务**:
- [ ] 移除旧的 UI 组件引用（Tabs、图表等）
- [ ] 移除不再使用的状态和方法
- [ ] 移除不再需要的导入
- [ ] 检查并移除不再使用的依赖包

**验收标准**:
- [ ] 无死代码
- [ ] 无未使用的导入
- [ ] 包依赖精简

**依赖**: 任务 5.1

**预计工时**: 1 小时

---

### 5.3 添加代码注释和文档

**状态**: `[x]`

**描述**: 为新代码添加完善的注释和文档。

**任务**:
- [ ] 为所有新增的接口添加 JSDoc 注释
- [ ] 为复杂的逻辑添加解释性注释
- [ ] 更新组件的文件头注释
- [ ] 为关键函数添加使用示例

**验收标准**:
- [ ] 所有公共接口有 JSDoc 注释
- [ ] 复杂逻辑有清晰注释
- [ ] 代码易于理解和维护

**依赖**: 任务 5.2

**预计工时**: 2 小时

---

### 5.4 更新用户文档

**状态**: `[x]`

**描述**: 更新面向用户的使用文档。

**任务**:
- [ ] 更新功能说明文档
- [ ] 添加新功能的使用指南
- [ ] 更新截图和示例
- [ ] 说明与旧版本的差异

**验收标准**:
- [ ] 文档完整准确
- [ ] 用户可以根据文档正常使用功能

**依赖**: 任务 5.3

**预计工时**: 2 小时

---

## 阶段 6: 部署和交付 (Deployment)

### 6.1 准备发布

**状态**: `[ ]`

**描述**: 准备代码发布。

**任务**:
- [ ] 运行完整的测试套件
- [ ] 运行 lint 检查
- [ ] 运行构建检查
- [ ] 创建 Pull Request
- [ ] 请求代码审查

**验收标准**:
- [ ] 所有测试通过
- [ ] 无 lint 错误
- [ ] 构建成功
- [ ] PR 创建并提交审查

**依赖**: 阶段 5 所有任务

**预计工时**: 1 小时

---

### 6.2 代码审查和修改

**状态**: `[ ]`

**描述**: 响应代码审查意见并修改。

**任务**:
- [ ] 处理审查意见
- [ ] 修改代码
- [ ] 更新测试
- [ ] 重新提交审查

**验收标准**:
- [ ] 所有审查意见已处理
- [ ] 审查通过

**依赖**: 任务 6.1

**预计工时**: 2-4 小时（取决于审查意见）

---

### 6.3 合并和部署

**状态**: `[ ]`

**描述**: 合并代码并部署到生产环境。

**任务**:
- [ ] 合并 PR 到主分支
- [ ] 部署到测试环境验证
- [ ] 部署到生产环境
- [ ] 监控上线后的状态

**验收标准**:
- [ ] 代码成功合并
- [ ] 生产环境功能正常
- [ ] 无重大 bug

**依赖**: 任务 6.2

**预计工时**: 1-2 小时

---

### 6.4 后续跟踪

**状态**: `[ ]`

**描述**: 跟踪上线后的反馈和问题。

**任务**:
- [ ] 收集用户反馈
- [ ] 监控错误日志
- [ ] 修复紧急 bug
- [ ] 记录改进建议

**验收标准**:
- [ ] 及时响应问题
- [ ] 用户满意度良好

**依赖**: 任务 6.3

**预计工时**: 持续跟踪

---

## 任务依赖关系图

```
阶段 1: 准备工作
├─ 1.1 DateRangePicker ────┐
├─ 1.2 Pagination ─────────┤
├─ 1.3 Store 状态定义 ─────┤
├─ 1.4 fetchHistoricalData ─┤
├─ 1.5 exportHistoricalData ┤
└─ 1.6 辅助 Actions ────────┘
           ↓
阶段 2: 核心重构
├─ 2.1 QueryFilters ────────┐
├─ 2.2 QueryResults ────────┤
├─ 2.3 DataQueryPage ───────┤
├─ 2.4 查询逻辑 ────────────┤
├─ 2.5 分页逻辑 ────────────┤
└─ 2.6 导出逻辑 ────────────┘
           ↓
阶段 3: UI/UX 优化
├─ 3.1 加载状态 ────────────┐
├─ 3.2 错误状态 ────────────┤
├─ 3.3 空结果状态 ──────────┤
├─ 3.4 表格优化 ────────────┤
└─ 3.5 快捷键 ──────────────┘
           ↓
阶段 4: 测试和验证
├─ 4.1 Store 测试 ──────────┐
├─ 4.2 组件测试 ────────────┤
├─ 4.3 集成测试 ────────────┤
└─ 4.4 手动测试 ────────────┘
           ↓
阶段 5: 优化和清理
├─ 5.1 代码优化 ────────────┐
├─ 5.2 移除废弃代码 ────────┤
├─ 5.3 代码注释 ────────────┤
└─ 5.4 用户文档 ────────────┘
           ↓
阶段 6: 部署和交付
├─ 6.1 准备发布 ────────────┐
├─ 6.2 代码审查 ────────────┤
├─ 6.3 合并部署 ────────────┤
└─ 6.4 后续跟踪 ────────────┘
```

## 并行任务建议

以下任务可以并行执行以提高效率：

**并行组 1（阶段 1）**:
- 任务 1.1 (DateRangePicker)
- 任务 1.2 (Pagination)
- 任务 1.3 (Store 状态定义)

**并行组 2（阶段 1）**:
- 任务 1.4 (fetchHistoricalData)
- 任务 1.5 (exportHistoricalData)
- 任务 1.6 (辅助 Actions)

**并行组 3（阶段 2）**:
- 任务 2.1 (QueryFilters)
- 任务 2.2 (QueryResults)

**并行组 4（阶段 3）**:
- 任务 3.1 (加载状态)
- 任务 3.2 (错误状态)
- 任务 3.3 (空结果状态)
- 任务 3.4 (表格优化)

**并行组 5（阶段 4）**:
- 任务 4.1 (Store 测试)
- 任务 4.2 (组件测试)

## 风险和注意事项

### 高风险任务

1. **任务 2.3 (重构 DataQueryPage)**
   - **风险**: 可能破坏现有功能
   - **缓解**: 做好备份，逐步重构，频繁测试

2. **任务 1.4 (fetchHistoricalData)**
   - **风险**: API 可能不支持新的查询模式
   - **缓解**: 提前与后端确认 API 能力

3. **任务 4.4 (手动测试)**
   - **风险**: 可能发现大量问题需要返工
   - **缓解**: 在开发过程中持续进行小范围测试

### 注意事项

1. **保持向后兼容**: 在移除旧代码前确保新功能完全可用
2. **频繁提交**: 每完成一个任务就提交代码，方便回滚
3. **及时沟通**: 遇到技术问题及时与团队沟通
4. **文档优先**: 关键决策和设计要先文档化

## 总结

本任务列表提供了详细的实施路线图。建议按阶段顺序执行，利用并行任务建议提高效率。每个任务都有明确的验收标准，确保质量可控。

---

**文档版本**: 1.0
**最后更新**: 2025-12-14
**作者**: AI Assistant
