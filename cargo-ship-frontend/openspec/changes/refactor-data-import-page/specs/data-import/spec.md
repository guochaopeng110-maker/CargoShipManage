# 数据导入功能规范

## ADDED Requirements

### Requirement: 三步走的文件上传流程

系统 **SHALL** 提供清晰的"三步走"文件上传流程，引导用户完成数据导入操作。

#### Scenario: 用户选择文件并开始上传

- **GIVEN** 用户在数据导入页面
- **WHEN** 用户选择或拖放一个 CSV 或 Excel 文件
- **THEN** 系统应当显示文件的基本信息（文件名、大小、类型）
- **AND** 系统应当提供一个明确的"开始上传"按钮
- **AND** 如果文件类型不支持或文件过大，系统应当显示错误提示

#### Scenario: 文件上传进度实时展示

- **GIVEN** 用户已选择文件并点击"开始上传"
- **WHEN** 文件开始上传
- **THEN** 系统应当显示实时的上传进度条（0-100%）
- **AND** 系统应当通过 ImportStatusIndicator 组件显示"上传中"状态
- **AND** 进度更新应当流畅且及时

#### Scenario: 上传完成后自动开始处理

- **GIVEN** 文件上传已完成（进度 100%）
- **WHEN** 后端开始处理数据
- **THEN** 系统应当自动将状态切换为"处理中"
- **AND** 系统应当显示处理中的动画（Spinner）
- **AND** 系统应当开始轮询后端的处理状态

---

### Requirement: 实时状态指示器

系统 **SHALL** 提供清晰的状态指示器（ImportStatusIndicator），展示当前导入任务的状态。

#### Scenario: 显示不同的导入状态

- **GIVEN** 用户在数据导入页面
- **WHEN** 导入任务处于不同的状态
- **THEN** 状态指示器应当显示对应的图标和文字：
  - idle: Clock icon + "等待上传"
  - uploading: Upload icon + "上传中 (XX%)"
  - processing: Spinner + "处理中"
  - success: CheckCircle icon + "导入成功"
  - error: AlertCircle icon + "导入失败" + 错误信息

#### Scenario: 状态切换流畅

- **GIVEN** 导入任务正在进行
- **WHEN** 状态从一个阶段切换到另一个阶段
- **THEN** 状态指示器应当平滑过渡，无闪烁
- **AND** 用户应当能够清楚地看到当前所处的阶段

---

### Requirement: 后端处理状态轮询

系统 **SHALL** 实现轮询机制，追踪后端的数据处理状态，直到任务完成。

#### Scenario: 文件上传后自动开始轮询

- **GIVEN** 文件上传成功并返回任务 ID
- **WHEN** 系统收到任务 ID
- **THEN** 系统应当自动开始轮询 `GET /api/imports/status/{taskId}` 接口
- **AND** 轮询间隔应当为 2-3 秒
- **AND** 每次轮询后应当更新 UI 状态

#### Scenario: 任务完成后停止轮询

- **GIVEN** 系统正在轮询任务状态
- **WHEN** 后端返回任务状态为 "completed" 或 "failed"
- **THEN** 系统应当立即停止轮询
- **AND** 系统应当更新状态指示器为最终状态
- **AND** 系统应当刷新历史导入记录列表
- **AND** 系统应当显示成功或失败的通知

#### Scenario: 用户离开页面时停止轮询

- **GIVEN** 系统正在轮询任务状态
- **WHEN** 用户离开数据导入页面或关闭浏览器标签页
- **THEN** 系统应当停止轮询，避免资源浪费
- **AND** 系统应当清理轮询相关的资源

---

### Requirement: 导入历史记录查询

系统 **SHALL** 提供历史导入记录的查询功能，支持筛选、分页和排序。

#### Scenario: 页面加载时自动查询历史记录

- **GIVEN** 用户打开数据导入页面
- **WHEN** 页面加载完成
- **THEN** 系统应当自动查询第一页的历史导入记录
- **AND** 系统应当显示加载状态
- **AND** 查询完成后应当在表格中展示记录

#### Scenario: 按文件名筛选历史记录

- **GIVEN** 用户在历史记录区域
- **WHEN** 用户在搜索框中输入文件名关键词
- **AND** 用户点击"执行查询"按钮
- **THEN** 系统应当查询包含该关键词的导入记录
- **AND** 系统应当更新表格显示筛选后的结果
- **AND** 系统应当重置页码为第一页

#### Scenario: 按状态筛选历史记录

- **GIVEN** 用户在历史记录区域
- **WHEN** 用户选择一个或多个状态筛选条件（如"已完成"、"失败"）
- **AND** 用户点击"执行查询"按钮
- **THEN** 系统应当查询符合所选状态的导入记录
- **AND** 系统应当更新表格显示筛选后的结果

#### Scenario: 分页浏览历史记录

- **GIVEN** 历史导入记录超过一页
- **WHEN** 用户点击分页组件的页码或"上一页"/"下一页"按钮
- **THEN** 系统应当查询对应页码的记录
- **AND** 系统应当更新表格显示
- **AND** 系统应当保持当前的筛选条件

---

### Requirement: 历史记录详细信息展示

系统 **SHALL** 为每条历史导入记录提供详细信息和操作功能。

#### Scenario: 查看导入记录详情

- **GIVEN** 用户在历史记录列表中
- **WHEN** 用户点击某条记录的"查看详情"按钮
- **THEN** 系统应当打开详情对话框
- **AND** 对话框应当显示：
  - 任务 ID
  - 文件名和文件大小
  - 上传时间、开始时间、完成时间
  - 总行数、成功行数、失败行数
  - 处理状态和进度
  - 导入选项和字段映射配置

#### Scenario: 查看导入错误报告

- **GIVEN** 某条导入记录的状态为"失败"或"部分完成"
- **WHEN** 用户点击"查看错误报告"按钮
- **THEN** 系统应当打开错误报告对话框
- **AND** 对话框应当列出所有失败的行及其错误原因
- **AND** 错误信息应当包括：行号、字段名、值、错误原因

#### Scenario: 重试失败的导入任务

- **GIVEN** 某条导入记录的状态为"失败"
- **WHEN** 用户点击"重试"按钮
- **THEN** 系统应当调用后端 API 重新执行导入
- **AND** 系统应当更新该记录的状态为"处理中"
- **AND** 系统应当开始轮询新的任务状态

---

### Requirement: 文件拖放上传支持

系统 **SHALL** 支持文件拖放上传，提供流畅的交互体验。

#### Scenario: 用户拖放文件到上传区

- **GIVEN** 用户在数据导入页面
- **WHEN** 用户将文件拖动到文件上传区域上方
- **THEN** 上传区域应当显示视觉反馈（如高亮边框、背景色变化）
- **AND** 当用户释放文件时，系统应当自动选择该文件
- **AND** 系统应当显示文件的基本信息

#### Scenario: 拖放无效文件时的处理

- **GIVEN** 用户在数据导入页面
- **WHEN** 用户拖放一个不支持的文件类型（如 .txt, .pdf）
- **THEN** 系统应当拒绝该文件
- **AND** 系统应当显示错误提示："仅支持 CSV 和 Excel 文件"
- **AND** 上传区域应当恢复到初始状态

---

### Requirement: 错误处理和用户反馈

系统 **SHALL** 提供完善的错误处理和用户反馈机制。

#### Scenario: 文件过大时的处理

- **GIVEN** 用户选择了一个超过 50MB 的文件
- **WHEN** 用户尝试上传该文件
- **THEN** 系统应当拒绝上传
- **AND** 系统应当显示错误提示："文件过大，请选择小于 50MB 的文件"

#### Scenario: 网络错误时的处理

- **GIVEN** 用户正在上传文件
- **WHEN** 发生网络错误（如断网、超时）
- **THEN** 系统应当停止上传
- **AND** 系统应当更新状态为"失败"
- **AND** 系统应当显示友好的错误提示："网络连接失败，请检查网络设置"
- **AND** 用户应当能够重新尝试上传

#### Scenario: 成功导入后的反馈

- **GIVEN** 导入任务已成功完成
- **WHEN** 系统收到"成功"状态
- **THEN** 系统应当显示成功通知（Toast）："数据导入成功"
- **AND** 系统应当更新历史记录列表
- **AND** 系统应当重置当前任务状态，准备下一次导入

---

### Requirement: 遵循 DataQueryPage 的筛选-分页列表模式

系统 **SHALL** 在历史导入记录功能中复用 DataQueryPage 确立的"筛选-分页列表"模式。

#### Scenario: 筛选条件和执行查询按钮

- **GIVEN** 用户在历史记录区域
- **WHEN** 用户配置筛选条件（文件名、状态等）
- **THEN** 系统不应当立即查询
- **AND** 用户应当需要点击"执行查询"按钮才触发查询
- **AND** 这一交互模式应当与 DataQueryPage 保持一致

#### Scenario: 分页组件的样式和交互

- **GIVEN** 历史记录列表有分页
- **WHEN** 用户查看分页组件
- **THEN** 分页组件的样式和交互应当与 DataQueryPage 保持一致
- **AND** 应当包括：页码显示、总页数、上一页/下一页按钮

---

## MODIFIED Requirements

无修改的现有需求（这是一个新功能）。

---

## REMOVED Requirements

无移除的需求。

---

## RENAMED Requirements

无重命名的需求。
