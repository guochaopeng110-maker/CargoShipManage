# 数据导入页面重构 - 任务列表

本文档详细列出了重构 DataImportPage 的所有任务，按阶段和优先级组织。每个任务都包含明确的验收标准。

## 任务概览

- **总任务数**: 28
- **预计工时**: 约 4-5 个工作日
- **依赖关系**: 部分任务可并行，部分需顺序执行

## 状态说明

- `[ ]` - 待开始 (Pending)
- `[~]` - 进行中 (In Progress)
- `[x]` - 已完成 (Completed)
- `[!]` - 已阻塞 (Blocked)

---

## 阶段 1: 准备工作 (Foundation)

### 1.1 创建 ImportStatusIndicator 组件

**状态**: `[ ]`

**描述**: 创建专门的状态指示器组件，用于展示导入任务的当前状态。

**任务**:
- [ ] 创建 `src/components/DataImportPage/ImportStatusIndicator.tsx`
- [ ] 实现五种状态的视觉展示：
  - `idle`: Clock icon + "等待上传"
  - `uploading`: Upload icon + "上传中 (XX%)" + 进度百分比
  - `processing`: Spinner icon + "处理中"
  - `success`: CheckCircle icon + "导入成功"
  - `error`: AlertCircle icon + "导入失败" + 错误信息
- [ ] 使用 Lucide React 图标库
- [ ] 支持动画效果（特别是 processing 状态）
- [ ] 符合项目 UI 设计规范（dark mode, glassmorphism）

**验收标准**:
- [ ] 组件可以正常渲染所有五种状态
- [ ] 图标和文字清晰可见
- [ ] 动画流畅自然
- [ ] TypeScript 类型定义完整
- [ ] 符合项目 UI 风格

**依赖**: 无

**预计工时**: 2-3 小时

---

### 1.2 创建 FileUploadZone 组件

**状态**: `[ ]`

**描述**: 创建独立的文件上传区域组件，支持拖拽和点击选择。

**任务**:
- [ ] 创建 `src/components/DataImportPage/FileUploadZone.tsx`
- [ ] 实现文件拖放功能
- [ ] 实现点击选择文件功能
- [ ] 显示已选文件的基本信息（文件名、大小、类型）
- [ ] 支持文件类型验证（CSV, Excel）
- [ ] 支持文件大小验证（如最大 50MB）
- [ ] 显示拖拽激活状态的视觉反馈

**验收标准**:
- [ ] 拖放功能正常工作
- [ ] 文件选择功能正常工作
- [ ] 文件信息正确显示
- [ ] 文件验证正常（类型、大小）
- [ ] 视觉反馈清晰
- [ ] 符合项目 UI 风格

**依赖**: 无

**预计工时**: 2-3 小时

---

### 1.3 创建 ImportHistoryTable 组件

**状态**: `[ ]`

**描述**: 创建导入历史记录表格组件，遵循 DataQueryPage 的"筛选-分页列表"模式。

**任务**:
- [ ] 创建 `src/components/DataImportPage/ImportHistoryTable.tsx`
- [ ] 实现表格列：
  - 任务 ID
  - 文件名（带文件图标）
  - 上传时间
  - 处理状态（带状态徽章）
  - 成功行数 / 失败行数
  - 进度条
  - 操作按钮（查看详情、重试、下载）
- [ ] 集成分页组件
- [ ] 支持筛选条件（文件名搜索、状态筛选）
- [ ] 支持排序（按时间、状态等）

**验收标准**:
- [ ] 表格正确显示所有列
- [ ] 分页功能正常
- [ ] 筛选功能正常
- [ ] 排序功能正常
- [ ] 符合 DataQueryPage 模式
- [ ] 符合项目 UI 风格

**依赖**: 需要分页组件（可能需要从其他页面复用）

**预计工时**: 3-4 小时

---

### 1.4 检查和准备 UI 组件

**状态**: `[ ]`

**描述**: 检查项目中是否已有所需的 UI 组件，如果没有则创建或复用。

**任务**:
- [ ] 检查 `src/components/ui/progress.tsx` 是否存在
- [ ] 检查 `src/components/ui/pagination.tsx` 是否存在
- [ ] 检查 `src/components/ui/spinner.tsx` 是否存在
- [ ] 如果缺少，从 DataQueryPage 或其他页面复用
- [ ] 确保所有组件符合项目规范

**验收标准**:
- [ ] 所有必要的 UI 组件都已准备好
- [ ] 组件可以正常导入和使用
- [ ] TypeScript 类型定义完整

**依赖**: 无

**预计工时**: 1 小时

---

## 阶段 2: 服务层扩展 (Service Layer)

### 2.1 扩展 import-service.ts - 新增 pollImportStatus 方法

**状态**: `[ ]`

**描述**: 在 import-service.ts 中新增轮询导入任务状态的方法。

**任务**:
- [ ] 打开 `src/services/import-service.ts`
- [ ] 新增 `pollImportStatus` 方法：
  ```typescript
  async pollImportStatus(
    taskId: string,
    onUpdate?: (status: ImportStatus) => void,
    interval: number = 2000
  ): Promise<ImportRecord>
  ```
- [ ] 实现轮询逻辑：
  - 定期调用 `GET /api/import/status/{taskId}`
  - 每次请求后调用 onUpdate 回调
  - 当状态为 'completed' 或 'failed' 时停止轮询
  - 返回最终的 ImportRecord
- [ ] 支持手动停止轮询（通过 AbortController）
- [ ] 添加错误处理和重试机制
- [ ] 添加详细的 JSDoc 注释

**验收标准**:
- [ ] 方法正确实现轮询逻辑
- [ ] 状态更新回调正常工作
- [ ] 轮询能够正确停止
- [ ] 错误处理完善
- [ ] TypeScript 类型定义完整
- [ ] 代码注释清晰

**依赖**: 需要后端 API 支持（如果没有，先使用 mock 数据）

**预计工时**: 3-4 小时

---

### 2.2 优化 import-service.ts - uploadFileWithProgress 方法

**状态**: `[ ]`

**描述**: 确保 uploadFileWithProgress 方法正确处理进度回调。

**任务**:
- [ ] 检查 `uploadFileWithProgress` 方法的实现
- [ ] 确保使用 XMLHttpRequest 或支持进度的 fetch 封装
- [ ] 确保 onProgress 回调被正确调用
- [ ] 测试进度更新的准确性
- [ ] 优化错误处理

**验收标准**:
- [ ] 进度回调正常工作
- [ ] 进度百分比准确（0-100）
- [ ] 上传完成后正确返回 ImportRecord
- [ ] 错误处理完善

**依赖**: 无

**预计工时**: 2 小时

---

## 阶段 3: 状态管理扩展 (State Management)

### 3.1 扩展 import-store.ts - 状态定义

**状态**: `[ ]`

**描述**: 在 import-store.ts 中扩展状态定义，支持"三步走"流程。

**任务**:
- [ ] 打开 `src/stores/import-store.ts`
- [ ] 在 `ImportState` 接口中添加/优化以下状态：
  ```typescript
  // 当前任务状态
  currentTask: {
    uploadProgress: number;
    importStatus: 'idle' | 'uploading' | 'processing' | 'success' | 'error';
    taskId: string | null;
    fileName: string | null;
    errorMessage: string | null;
  };

  // 历史记录状态（遵循 DataQueryPage 模式）
  historicalImports: {
    items: ImportRecord[];
    total: number;
    page: number;
    pageSize: number;
    totalPages: number;
  };

  // 查询状态
  queryStatus: 'idle' | 'loading' | 'success' | 'error';
  queryFilters: ImportRecordFilters;

  // 轮询控制
  pollingAbortController: AbortController | null;
  ```
- [ ] 初始化所有新增状态的默认值
- [ ] 确保 TypeScript 类型定义完整

**验收标准**:
- [ ] 状态定义完整且清晰
- [ ] 初始值正确
- [ ] TypeScript 编译无错误
- [ ] 代码注释清晰

**依赖**: 无

**预计工时**: 1-2 小时

---

### 3.2 扩展 import-store.ts - 上传和轮询 Actions

**状态**: `[ ]`

**描述**: 实现文件上传和状态轮询的 store actions。

**任务**:
- [ ] 实现 `uploadFileWithProgress` action：
  - 调用 import-service 的 uploadFileWithProgress 方法
  - 更新 uploadProgress 状态
  - 更新 importStatus 为 'uploading'
  - 上传完成后返回 taskId
- [ ] 实现 `pollImportStatus` action：
  - 调用 import-service 的 pollImportStatus 方法
  - 更新 importStatus 为 'processing'
  - 定期更新任务状态
  - 完成后更新为 'success' 或 'error'
- [ ] 实现 `stopPolling` action：
  - 停止当前的轮询
  - 清理 AbortController
- [ ] 实现 `resetCurrentTask` action：
  - 重置当前任务状态
  - 准备下一次导入

**验收标准**:
- [ ] 上传 action 正常工作
- [ ] 轮询 action 正常工作
- [ ] 停止轮询功能正常
- [ ] 重置功能正常
- [ ] 状态更新正确
- [ ] 错误处理完善

**依赖**: 2.1 pollImportStatus 方法

**预计工时**: 3-4 小时

---

### 3.3 扩展 import-store.ts - 历史记录 Actions

**状态**: `[ ]`

**描述**: 实现历史导入记录查询的 store actions，遵循 DataQueryPage 模式。

**任务**:
- [ ] 实现 `fetchImportHistory` action：
  ```typescript
  async fetchImportHistory(
    page: number,
    filters?: ImportRecordFilters
  ): Promise<void>
  ```
  - 调用 import-service 的 getImportRecords 方法
  - 更新 queryStatus 为 'loading'
  - 更新 historicalImports 状态
  - 完成后更新 queryStatus 为 'success' 或 'error'
- [ ] 实现 `setQueryFilters` action：
  - 更新筛选条件
  - 自动重新查询第一页
- [ ] 实现 `setQueryPage` action：
  - 更新当前页码
  - 重新查询数据

**验收标准**:
- [ ] 历史记录查询正常
- [ ] 筛选功能正常
- [ ] 分页功能正常
- [ ] 状态更新正确
- [ ] 遵循 DataQueryPage 模式

**依赖**: import-service 的 getImportRecords 方法

**预计工时**: 2-3 小时

---

## 阶段 4: UI 重构 (UI Refactoring)

### 4.1 重构 DataImportPage.tsx - 整体布局

**状态**: `[ ]`

**描述**: 重构 DataImportPage 的整体布局，实现"三步走"设计。

**任务**:
- [ ] 打开 `src/components/DataImportPage.tsx`
- [ ] 重构页面布局为三个主要区域：
  - **第一步：文件选择区**（使用 FileUploadZone 组件）
  - **第二步：上传与处理状态区**（使用 ImportStatusIndicator 组件）
  - **第三步：导入历史区**（使用 ImportHistoryTable 组件）
- [ ] 实现清晰的视觉分隔和层次
- [ ] 保持与项目其他页面一致的 dark mode 风格
- [ ] 优化响应式布局

**验收标准**:
- [ ] 页面布局清晰，三个区域分明
- [ ] 视觉效果符合设计规范
- [ ] 响应式布局正常
- [ ] TypeScript 编译无错误

**依赖**: 1.1, 1.2, 1.3 组件创建完成

**预计工时**: 3-4 小时

---

### 4.2 重构 DataImportPage.tsx - 第一步：文件选择区

**状态**: `[ ]`

**描述**: 实现第一步的文件选择和上传逻辑。

**任务**:
- [ ] 集成 FileUploadZone 组件
- [ ] 实现文件选择后的状态更新
- [ ] 显示文件基本信息（文件名、大小、类型）
- [ ] 添加"开始上传"按钮
- [ ] 按钮状态控制：
  - 未选择文件时禁用
  - 正在上传时禁用
  - 正常情况下启用
- [ ] 实现文件上传的触发逻辑

**验收标准**:
- [ ] 文件选择功能正常
- [ ] 文件信息正确显示
- [ ] 按钮状态控制正确
- [ ] 上传触发正常

**依赖**: 1.2 FileUploadZone 组件

**预计工时**: 2-3 小时

---

### 4.3 重构 DataImportPage.tsx - 第二步：上传与处理状态区

**状态**: `[ ]`

**描述**: 实现第二步的上传进度和处理状态展示。

**任务**:
- [ ] 集成 ImportStatusIndicator 组件
- [ ] 绑定 store 的 currentTask 状态
- [ ] 实现上传进度条的更新
- [ ] 实现状态指示器的状态切换：
  - idle → uploading（显示进度）
  - uploading → processing（显示 spinner）
  - processing → success / error（显示结果）
- [ ] 添加处理中的动画效果
- [ ] 显示错误信息（如果失败）

**验收标准**:
- [ ] 状态指示器正确显示当前状态
- [ ] 上传进度实时更新
- [ ] 处理中动画流畅
- [ ] 错误信息正确显示

**依赖**: 1.1 ImportStatusIndicator 组件，3.2 上传和轮询 actions

**预计工时**: 2-3 小时

---

### 4.4 重构 DataImportPage.tsx - 第三步：导入历史区

**状态**: `[ ]`

**描述**: 实现第三步的导入历史记录展示，遵循 DataQueryPage 模式。

**任务**:
- [ ] 集成 ImportHistoryTable 组件
- [ ] 绑定 store 的 historicalImports 状态
- [ ] 实现筛选条件：
  - 文件名搜索
  - 状态筛选（待处理、处理中、已完成、失败）
  - 日期范围（可选）
- [ ] 实现"执行查询"按钮
- [ ] 集成分页组件
- [ ] 实现排序功能（按时间、状态等）
- [ ] 实现操作按钮：
  - 查看详情（打开详情对话框）
  - 重试导入（失败的任务）
  - 下载结果（成功的任务）

**验收标准**:
- [ ] 历史记录正确显示
- [ ] 筛选功能正常
- [ ] 分页功能正常
- [ ] 排序功能正常
- [ ] 操作按钮正常
- [ ] 遵循 DataQueryPage 模式

**依赖**: 1.3 ImportHistoryTable 组件，3.3 历史记录 actions

**预计工时**: 3-4 小时

---

## 阶段 5: 数据流集成 (Data Flow Integration)

### 5.1 实现完整的导入流程

**状态**: `[ ]`

**描述**: 将所有组件和 actions 集成，实现完整的导入流程。

**任务**:
- [ ] 实现文件选择 → 上传 → 轮询 → 完成的完整流程
- [ ] 确保状态在整个流程中正确流转
- [ ] 实现以下用户操作：
  1. 用户选择文件
  2. 点击"开始上传"
  3. 上传进度实时更新（0% → 100%）
  4. 上传完成后自动开始轮询
  5. 处理状态实时更新（处理中 → 成功/失败）
  6. 处理完成后刷新历史记录列表
  7. 显示成功/失败提示（使用 toast）
- [ ] 添加错误处理和用户提示
- [ ] 支持中途取消上传（可选）

**验收标准**:
- [ ] 完整流程无中断
- [ ] 状态流转正确
- [ ] 用户反馈及时
- [ ] 错误处理完善

**依赖**: 所有前置任务

**预计工时**: 3-4 小时

---

### 5.2 实现历史记录查询流程

**状态**: `[ ]`

**描述**: 实现历史导入记录的查询、筛选、分页流程。

**任务**:
- [ ] 页面加载时自动查询第一页历史记录
- [ ] 实现筛选条件变化时的自动查询
- [ ] 实现分页切换时的查询
- [ ] 实现排序变化时的查询
- [ ] 确保查询状态正确更新（loading, success, error）
- [ ] 添加加载动画和错误提示

**验收标准**:
- [ ] 初始加载正常
- [ ] 筛选查询正常
- [ ] 分页查询正常
- [ ] 排序查询正常
- [ ] 状态反馈正确

**依赖**: 3.3 历史记录 actions，4.4 导入历史区

**预计工时**: 2-3 小时

---

### 5.3 实现轮询任务状态的完整流程

**状态**: `[ ]`

**描述**: 确保轮询机制能够正确工作，并在任务完成后停止。

**任务**:
- [ ] 文件上传成功后自动启动轮询
- [ ] 轮询期间定期更新 UI 状态
- [ ] 任务完成后自动停止轮询
- [ ] 支持手动停止轮询（如果用户离开页面）
- [ ] 处理轮询过程中的错误（如网络错误）
- [ ] 添加超时机制（如果后端长时间无响应）

**验收标准**:
- [ ] 轮询自动启动
- [ ] 状态实时更新
- [ ] 自动停止正常
- [ ] 手动停止正常
- [ ] 错误处理完善
- [ ] 超时处理正常

**依赖**: 2.1 pollImportStatus 方法，3.2 轮询 actions

**预计工时**: 2-3 小时

---

## 阶段 6: 测试和优化 (Testing & Optimization)

### 6.1 功能测试

**状态**: `[ ]`

**描述**: 进行全面的功能测试，确保所有功能正常工作。

**任务**:
- [ ] 测试文件选择和上传功能
- [ ] 测试上传进度展示
- [ ] 测试状态轮询功能
- [ ] 测试历史记录查询功能
- [ ] 测试筛选和分页功能
- [ ] 测试排序功能
- [ ] 测试操作按钮（查看详情、重试、下载）
- [ ] 测试错误处理（网络错误、文件过大、文件类型错误等）
- [ ] 测试边界情况（空列表、第一页、最后一页等）

**验收标准**:
- [ ] 所有功能正常工作
- [ ] 无明显 bug
- [ ] 边界情况处理正确
- [ ] 错误提示友好

**依赖**: 所有前置任务

**预计工时**: 3-4 小时

---

### 6.2 性能优化

**状态**: `[ ]`

**描述**: 优化页面性能，确保流畅的用户体验。

**任务**:
- [ ] 优化组件渲染性能（使用 React.memo 等）
- [ ] 优化轮询机制（合理的轮询间隔）
- [ ] 优化大量历史记录的渲染（虚拟滚动，如果需要）
- [ ] 减少不必要的 API 请求
- [ ] 优化状态更新逻辑
- [ ] 添加加载状态和骨架屏（如果需要）

**验收标准**:
- [ ] 页面加载快速
- [ ] 交互响应流畅
- [ ] 无明显卡顿
- [ ] API 请求合理

**依赖**: 6.1 功能测试

**预计工时**: 2-3 小时

---

### 6.3 UI/UX 调优

**状态**: `[ ]`

**描述**: 优化用户界面和用户体验。

**任务**:
- [ ] 优化视觉样式和布局
- [ ] 优化动画效果
- [ ] 优化错误提示和成功提示
- [ ] 优化加载状态展示
- [ ] 优化响应式布局
- [ ] 确保符合项目 UI 设计规范
- [ ] 进行可访问性优化（如果需要）

**验收标准**:
- [ ] 视觉效果美观
- [ ] 动画流畅自然
- [ ] 用户反馈及时清晰
- [ ] 响应式布局正常
- [ ] 符合项目风格

**依赖**: 6.1 功能测试

**预计工时**: 2-3 小时

---

## 阶段 7: 文档和交付 (Documentation & Delivery)

### 7.1 代码注释和文档

**状态**: `[ ]`

**描述**: 完善代码注释和文档。

**任务**:
- [ ] 为所有新增组件添加 JSDoc 注释
- [ ] 为所有新增 actions 添加详细注释
- [ ] 为复杂的业务逻辑添加说明注释
- [ ] 更新相关的类型定义文件
- [ ] 创建或更新用户文档（如果需要）

**验收标准**:
- [ ] 代码注释完整清晰
- [ ] TypeScript 类型定义完整
- [ ] 文档准确且易懂

**依赖**: 所有前置任务

**预计工时**: 2-3 小时

---

### 7.2 代码审查和清理

**状态**: `[ ]`

**描述**: 进行代码审查，清理不必要的代码。

**任务**:
- [ ] 移除已废弃的代码和注释
- [ ] 统一代码风格（运行 prettier/eslint）
- [ ] 检查并移除 console.log 等调试代码
- [ ] 检查 TypeScript 类型错误
- [ ] 确保所有导入语句正确
- [ ] 进行 peer review（如果有团队成员）

**验收标准**:
- [ ] 代码整洁无冗余
- [ ] 代码风格一致
- [ ] 无 TypeScript 错误
- [ ] 通过 linter 检查

**依赖**: 7.1 代码注释和文档

**预计工时**: 2-3 小时

---

### 7.3 最终验证

**状态**: `[ ]`

**描述**: 进行最终的全面验证，确保所有功能正常且符合需求。

**任务**:
- [ ] 再次运行完整的功能测试
- [ ] 验证是否符合提案中的所有需求
- [ ] 验证是否复用了 DataQueryPage 的模式
- [ ] 验证"三步走"布局是否清晰
- [ ] 验证状态轮询是否正常
- [ ] 验证用户体验是否流畅
- [ ] 检查是否有遗漏的功能
- [ ] 确认可以提交 PR

**验收标准**:
- [ ] 所有需求都已实现
- [ ] 所有测试都通过
- [ ] 用户体验良好
- [ ] 符合技术规范
- [ ] 可以提交 PR

**依赖**: 所有前置任务

**预计工时**: 2-3 小时

---

## 任务依赖关系图

```
阶段 1: 准备工作
├─ 1.1 ImportStatusIndicator 组件 ─────┐
├─ 1.2 FileUploadZone 组件 ───────────┤
├─ 1.3 ImportHistoryTable 组件 ───────┤
└─ 1.4 检查 UI 组件 ──────────────────┤
                                      │
阶段 2: 服务层扩展                      │
├─ 2.1 pollImportStatus 方法 ─────────┤
└─ 2.2 uploadFileWithProgress 优化 ───┤
                                      │
阶段 3: 状态管理扩展                    │
├─ 3.1 状态定义 ─────────────────────┤
├─ 3.2 上传和轮询 actions ────────────┤
└─ 3.3 历史记录 actions ──────────────┤
                                      │
阶段 4: UI 重构                        │
├─ 4.1 整体布局 ─────────────────────┤
├─ 4.2 第一步：文件选择区 ────────────┤
├─ 4.3 第二步：上传处理状态区 ────────┤
└─ 4.4 第三步：导入历史区 ────────────┤
                                      │
阶段 5: 数据流集成                      │
├─ 5.1 完整导入流程 ─────────────────┤
├─ 5.2 历史记录查询流程 ──────────────┤
└─ 5.3 轮询任务状态流程 ──────────────┤
                                      │
阶段 6: 测试和优化                      │
├─ 6.1 功能测试 ─────────────────────┤
├─ 6.2 性能优化 ─────────────────────┤
└─ 6.3 UI/UX 调优 ───────────────────┤
                                      │
阶段 7: 文档和交付                      │
├─ 7.1 代码注释和文档 ────────────────┤
├─ 7.2 代码审查和清理 ────────────────┤
└─ 7.3 最终验证 ─────────────────────┘
```

## 并行任务建议

以下任务可以并行执行以提高效率：

**并行组 1（阶段 1）**:
- 1.1 ImportStatusIndicator 组件
- 1.2 FileUploadZone 组件
- 1.3 ImportHistoryTable 组件
- 1.4 检查 UI 组件

**并行组 2（阶段 2）**:
- 2.1 pollImportStatus 方法
- 2.2 uploadFileWithProgress 优化

**并行组 3（阶段 3）**:
- 3.1 状态定义
- （3.2 和 3.3 需要在 3.1 完成后）

**并行组 4（阶段 4）**:
- 4.2, 4.3, 4.4 可以在 4.1 完成后并行开发

**并行组 5（阶段 6）**:
- 6.2 性能优化
- 6.3 UI/UX 调优

## 风险与注意事项

1. **后端 API 依赖**
   - 如果后端尚未实现 `GET /api/import/status/{taskId}` 接口
   - 建议先使用 mock 数据开发，后续再集成真实 API

2. **轮询性能**
   - 注意轮询间隔不要太短，避免给服务器造成压力
   - 建议使用 2-3 秒的轮询间隔

3. **状态管理复杂度**
   - 同时管理上传状态、处理状态、历史记录可能增加复杂度
   - 建议清晰划分状态，添加详细注释

4. **组件复用**
   - 优先复用现有的 UI 组件和模式
   - 避免重复造轮子

---

**任务列表创建日期**: 2025-12-14
**最后更新**: 2025-12-14
**维护者**: AI Assistant
