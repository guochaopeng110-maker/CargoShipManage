# CargoShipManagement 前端重构方案 (最终版)

## 一、 核心原则：严格遵守，精准执行，并兼顾未来

1.  **精确的导航结构**: 我们将严格按照您提供的`sidebar`结构进行页面路由和导航配置，不做任何增删或层级改动。
2.  **统一的视觉风格和自适应性**: 完全保留项目现有的**色调风格、背景、主布局（含侧边栏、顶部栏）、UI组件风格及自适应样式**。**所有功能和组件必须在现有设计体系内实现，并确保在各种终端（不同屏幕尺寸、设备）上都有良好的响应式体验。**
3.  **丰富且直观的数据可视化**: 监测页面将引入更丰富的图表类型，对关键指标进行具象化、焦点化展示，提升数据直观性。**展示监测指标时，必须用带有意义的图标和较强的动画效果。**
4.  **数据流统一**: **所有设备数据（无论是历史数据查询还是实时数据更新），均视为由后端通过WebSocket推送而来的统一数据流。前端 `stores` 将管理并展示此数据流，避免混淆。**
5.  **代码整洁高效**: **在整个重构过程中，将持续关注代码质量。对于不再需要的`.tsx`、`.ts`文件或代码片段，将在相应阶段或最终清理阶段坚决删除，保持代码库的精简和高效。**
6.  **服务分层封装**: **所有数据请求必须遵循分层架构**。
    *   **HTTP请求**: 对于非WebSocket驱动的HTTP请求（如用户认证、数据查询），必须创建或重用高层服务（如`auth-service.ts`）。该服务内部**必须**调用 `src/services/api` 中自动生成的客户端方法。
    *   **数据流**: UI组件**禁止**直接调用底层API客户端或自行发起请求，**必须**通过高层服务或 `stores` 获取数据。
7.  **统一的异常处理**: 建立统一的错误处理机制，所有在 `services` 或 `stores` 中捕获的异常应交由全局错误处理器进行标准化处理和用户反馈。

---

## 二、 信息架构与路由：按图索骥

我们将完全采纳您指定的导航结构。重构工作将在不改变此结构的前提下，对各链接指向的页面组件进行深度改造。

**确认的`Sidebar`结构：**

*   **驾控台 (Dashboard)**
*   **监测与报警 (Live Monitoring And Alarm)** (菜单组)
    *   推进系统 (`PropulsionMonitoringPage`)
    *   电池储能 (`BatteryMonitoringPage`)
    *   逆变器 (`InverterMonitoringPage`)
    *   配电系统 (`PowerDistributionPage`) - *建议为此新建或重命名一个页面组件*
    *   辅助系统 (`AuxiliarySystemsPage`) - *建议为此新建或重命名一个页面组件*
*   **告警中心 (Alarm Center)**
*   **数据中心 (Data Hub)** (菜单组)
    *   数据查询 (`DataQueryPage`)
    *   历史数据导入 (`DataImportPage`)
*   **健康评估 (Health Assessment)** (`HealthAssessmentPage`)
*   **视情维护 (Condition-Based Maintenance)** (菜单组, UI保留)
    *   维护计划 (`MaintenancePlanPage`)
    *   维护历史 (`MaintenanceHistoryPage`)
*   **辅助决策 (Decision Support)** (菜单组, UI保留)
    *   决策建议 (`DecisionSuggestionsPage`)
    *   能效优化 (`EnergyOptimizationPage`)
    *   复杂工况操作 (`ComplexOperationsPage`)
*   **系统管理 (System Administration)** (菜单组)
    *   设备管理 (`DeviceManagementPage`)
    *   用户管理 (`UserManagementPage`)
    *   角色与权限 (`RoleManagementPage`)
*   **个人账户 (My Account)** (菜单组)

---

## 三、 阶段性重构方案：融合最佳实践

### **第一阶段：地基与准备 (Foundation & Preparation)**
1.  **搭建自动化数据层**:
    *   **【技术实现】** 引入 `openapi-typescript-codegen` 等工具，根据 `docs/data/http-api.json` 自动生成类型安全的API客户端。
    *   **【技术实现】** 搭建 `src/services/realtime-service.ts` 的基础框架，准备与Socket.io (依据 `docs/data/websocket-api.md`) 进行对接。
    *   **【技术实现】** 建立各业务模块的Zustand `stores` 文件结构 (`monitoring-store`, `alarms-store` 等)。
    *   **【数据流核心原则】** 在 `stores` (例如 `monitoring-store`) 中，我们将只存储和管理后端通过WebSocket推送来的设备数据流在客户端的缓存。前端UI组件将直接从这些 `stores` 获取数据进行展示，无需区分数据来源是“历史”还是“实时”，所有更新均由 `realtime-service` 驱动。
2.  **划定范围与占位 (根据最新指示重定义)**:
    *   **【项目管理】** 再次确认所有路由与`Sidebar`结构精确匹配。
    *   **【UI/UX策略】** `视情维护`和`辅助决策`菜单下的所有页面（如`MaintenancePlanPage`, `DecisionSuggestionsPage`等）**将保留其UI界面骨架，但不进行后端功能实现**。这些页面将作为占位符存在，以保持导航结构的完整性，但现阶段不投入开发资源。

### **第二阶段：核心能力建设 (Core Capabilities)**
1.  **开发核心可视化组件 (强化UI/UX要求)**:
    *   **【UI/UX要求】图标系统 (根据最新指示重定义)**: 创建一个 `Icon` 组件库或图标映射规则。**目标是为所有设备系统的每一个监测点指标，设计并匹配独特的、有意义的SVG图标**，而不仅是按指标类型（如电压、温度）进行宽泛分类。
    *   **【UI/UX要求】动画效果**: **所有图表（特别是代表监测点的图标）必须具有较强的动画效果**。在开发 `GaugeChart`, `DonutChart` 及其他关键状态指示器组件时，必须融入流畅且视觉冲击力强的动画效果。例如，仪表盘指针应以动画形式平滑过渡到新数值；状态变化（如设备告警）时应有明显的脉冲、闪烁或渐变动画，以吸引用户注意力。可考虑使用 `framer-motion` 或高级CSS动画技术。
    *   **【技术实现】** 这些组件必须支持接收实时数据更新，并能响应式地渲染，同时兼容不同屏幕尺寸。
2.  **完善数据动脉**:
    *   **【技术实现】** 完成 `realtime-service.ts` 的全部逻辑，使其能稳定连接、认证、管理订阅（`subscribe:equipment`），并处理所有来自 `websocket-api.md` 定义的推送事件。
    *   **【技术实现】** 完善 `stores` 逻辑，使其能正确地接收、存储和管理来自 `realtime-service` 的数据流，并确保其响应式更新能力。

### **第三阶段：页面试点与模板确立 (Pilot & Templating)**
1.  **实现`BatteryMonitoringPage`试点页面 (根据最新指示重定义)**:
    *   **【UI重定义】** `BatteryMonitoringPage` 的布局将进行调整。**顶部区域将重构为一个“监控墙”或“仪表板”，用以展示电池系统的所有监测点指标**，而非少数关键指标。动画效果的重点将体现在每个指标所配备的动态Icon上。
    *   **【UI重定义】** **移除中部的统一监控图表区和底部的详细参数列表区。** 页面的**底部区域将专门用作电池系统设备的告警区**。
    *   **【数据层面】** 此页面的所有数据流（包括实时更新与告警信息）均通过新方案设计的 `stores` 和 `services` 来驱动。页面加载时调用 `realtime-service` 订阅相应设备的实时数据，页面卸载时取消订阅。

2.  **确立`HealthAssessmentPage`模板**:
    *   **【核心定位】** 专注于对历史和当前数据进行分析后得出的“结论”，即设备健康状态的评估、诊断和趋势预测。
    *   **【布局方案】** 采用“总-分-细”的三段式布局。
        *   **顶部 (总)**: 使用一个大型动态“健康仪表盘”或“计分卡”组件，展示全船的综合健康评分，并以颜色和文字清晰标识健康等级。
        *   **中部 (分)**: 采用“系统健康卡片”网格，每个卡片展示一个分系统的独立健康评分、微型趋势图和活跃告警数，并可点击跳转至该系统的详细监控页。
        *   **底部 (细)**: 设置一个数据表格，用于展示和管理历史健康评估报告。
    *   **【数据流】** 页面所有数据均通过 `health-store` 获取，该store的数据由 `realtime-service` 实时推送。

3.  **确立`DashboardPage` (驾控台) 模板**:
    *   **【核心定位】** 专注于当下最核心的“实时状态”，是一个高度聚合的、用于快速掌握全局态势的入口。
    *   **【布局方案】** 采用模块化、可定制的“小组件”(Widget) 布局，聚合各核心页面的“迷你版”。
        *   **核心组件1 - 状态监控墙**: 精选全船8-12个最关键的核心实时参数，以动画图标和数值组成跨系统的“超级仪表板”。
        *   **核心组件2 - 告警摘要**: 统计各级别告警数量，滚动显示最新紧急告警，并提供“进入告警中心”的快速入口。
        *   **核心组件3 - 健康速览**: 展示一个微缩版的全船综合健康评分图，可点击跳转至完整的健康评估页。
        *   **核心组件4 - 快捷操作**: 提供指向常用功能页面的链接。
    *   **【数据流】** 作为“超级消费者”，同时从 `monitoring-store`, `alarms-store`, `health-store` 等多个store中获取数据。

4.  **确立`DataQueryPage` (数据查询页) 模板**:
    *   **【核心设计思路】** 聚焦于高效的原始数据查询与导出，将页面简化为以**数据表格为中心**的单一视图，移除所有图表和不必要的聚合功能。
    *   **【界面与组件重构方案】**
        *   **查询条件区**: 仅保留**设备选择**、**监控参数多选**和**日期范围选择**。其中，“日期范围”将使用标准的日期范围选择器(Date Range Picker)替代精确到秒的时间输入，但保留“最近7天”等快捷预设。移除“高级选项”（如时间粒度、聚合类型）。
        *   **结果展示区**: 移除所有Tabs，页面只包含一个**带分页功能的数据表格**。该表格将根据API返回的分页信息(`total`, `page`, `pageSize`)，让用户能够浏览全部查询结果。
        *   **功能操作区**: 保留“执行查询”和“数据导出”(Excel, CSV, JSON)功能。
    *   **【数据流与逻辑重构方案】**
        *   **API请求**: 查询时，将用户选择的起止**日期**转换为当日的起始和结束时间戳，连同分页参数，一同调用`/api/monitoring/data`接口。
        *   **状态管理**: `monitoring-store`将增加存储分页信息的状态（如`totalPages`, `currentPage`）。
        *   **组件响应**: 表格和新增的分页组件都将响应Store中的数据和分页状态变化。

### **第四阶段：全面实现与模板应用 (Full Implementation & Rollout)**
1.  **应用模板，重构核心页面**:
    *   **【项目管理】** 根据第三阶段确立的模板，并行完成以下核心页面的重构工作：
        *   **监控页面**: 将`BatteryMonitoringPage`的“监控墙”模式复制到其余4个监控页面（`推进系统`, `逆变器`, `配电系统`, `辅助系统`）。
        *   **驾控台**: 按照新的小组件化模板实现 `DashboardPage`。
        *   **健康评估**: 按照新的“总-分-细”三段式模板实现 `HealthAssessmentPage`。
2.  **实现其余功能页面 (并完成服务层重构)**:
    *   **【项目管理】** 在实现各功能模块页面的同时，必须完成其对应高层服务 (`src/services/*.ts`) 的重构，使其遵循新的服务分层封装原则。
    *   **任务：告警中心**:
        *   **【服务重构】**: 重构 `alarms-service.ts` 和 `alarms-store.ts`，使其全面对接到新的数据层架构。
        *   **【页面实现】**: 使用重构后的`store`和`service`，完成`告警中心`页面的UI和交互逻辑。
    *   **任务：数据中心**:
        *   **【服务重构】**: 重构 `import-service.ts`，并确保 `DataQueryPage` 的API调用遵循HTTP服务封装原则。
        *   **【页面实现】**: 完成`历史数据导入`和`数据查询`页面的实现。
    *   **任务：系统管理**:
        *   **【服务重构】**: 重构 `auth-service.ts` (涉及用户/角色管理)等相关服务。
        *   **【页面实现】**: 完成`设备管理`、`用户管理`和`角色与权限`页面的实现。

### **第五阶段：整合、清理与交付 (Integration, Cleanup & Delivery)**
1.  **整合与收尾**:
    *   **【代码规范】** 全面清理项目中手写的、可被自动生成的TypeScript类型，统一类型源。
2.  **【核心要求】代码大扫除 (Project-Wide Code Cleanup)**:
    *   **【代码质量】** 在所有重构任务完成后，进行一次彻底的项目代码审查。
    *   **【代码质量】坚决删除所有在此次重构中被废弃或不再需要的 `.tsx` 和 `.ts` 文件**（例如旧的服务文件、已被`UnderDevelopmentPage`替换的页面组件、旧的类型定义文件）。
    *   **【代码质量】** 清理组件内部不再使用的函数、变量和导入，确保最终代码库的精简、高效和高内聚。
3.  **测试与验证 (持续进行)**:
    *   **【测试策略】** **测试应贯穿于所有阶段**：在实现`stores`、`services`和核心组件时，同步编写单元测试；在页面重构时，编写集成测试。
    *   **【Mock数据】** 更新 `src/mocks` 数据，使其与新API定义一致，以支持测试和本地开发。
    *   **【质量保障】** 在交付前，进行一次覆盖所有功能、UI、实时性、响应式和性能的端到端回归测试。