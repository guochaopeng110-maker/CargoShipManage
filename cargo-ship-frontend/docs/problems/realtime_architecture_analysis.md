# 货船智能机舱管理系统实时数据与告警架构分析报告

## 1. 现状架构分析

目前系统的实时通信基于 **WebSocket (Socket.IO)**，采用 **Zustand** 进行状态管理。数据流向遵循：
`后端推送` -> `RealtimeService (单例)` -> `Stores (Zustand)` -> `UI 组件`。

### 1.1 初始化流程
1.  **认证完成后**：`App.tsx` 中的 `AuthenticatedApp` 监测到登录状态，调用 `realtimeService.connect()`。
2.  **监测数据初始化**：调用 `monitoringStore.init(token)`，注册实时监测点数据的底层监听。
3.  **告警初始化**：调用 `alarmsStore.initSubscription()`，注册全局告警推送监听。

### 1.2 页面级监听机制（现有）
- **按需订阅**：5 个监测专页（推进、电池、配电等）在组件挂载时通过设备 ID 调用 `subscribeToDevice`。
- **生命周期清理**：组件卸载时调用 `unsubscribeFromDevice` 并执行 Store 的 `cleanup()`。

---

## 2. 发现的问题与瓶颈

### 2.1 状态重置导致的 UI 误报（蝴蝶效应）
- **现象**：当用户离开任一监测页面时，TopBar 的连接状态会变成“未连接”。
- **成因**：子页面卸载时错误地调用了全局 Store 的 `cleanup()` 方法。该方法重置了全局单例 Store 中的 `realtimeConnected` 状态，导致所有监听该状态的公共组件（如 TopBar、Sidebar）显示异常，尽管底层的物理连接并未断开。

### 2.2 驾控台（Dashboard）数据冻结
- **现象**：驾控台上的核心指标数据可能不更新或在切换页面后冻结。
- **成因**：由于 Dashboard 目前依赖硬编码的指标 ID 且没有独立订阅机制。如果子页面执行了 `unsubscribe` 操作，后端将停止向该设备推送数据，导致 Dashboard 同样无法获取实时更新。

### 2.3 冗余的页面级管理
- 由于核心系统设备数量较少（约 8 个），频繁地在 5 个页面进行“订阅-卸载”操作增加了逻辑复杂度和网络握手开销，且与 Dashboard 的常驻监控需求冲突。

---

## 3. 优化方案建议（全局数据总线模式）

### 3.1 核心设备动态化
- **ID 动态获取**：8 个核心设备的 ID 不应硬编码，应在系统启动时从设备管理接口（`fetchEquipmentList`）获取，以适配 ID 变更。
- **固定参数映射**：业务层面的监测点代码（如 SOC、温度）保持固定，通过 `{设备ID}:{测点代码}` 进行 UI 绑定。

### 3.2 全局统一订阅策略
- **一次订阅，全时在线**：在应用初始化阶段，一次性订阅 8 个核心系统的所有设备。
- **取消页面级清理**：移除监测专页卸载时的销毁逻辑。将这些设备视为系统的“基底数据”，只要会话存续，数据就应保持流动。
- **精准资源管理**：
    - **挂载时**：直接从 Store 读取已存在的存量数据，实现页面“秒开”。
    - **卸载时**：不做任何清理，为 Dashboard 或其他页面储备数据。
    - **退出时**：仅在用户执行登出操作时，彻底断开 WebSocket 连接。

### 3.3 数据展示逻辑解耦
- **分拣机制**：Store 继续承担“分拣员”角色，将离散的报文按设备索引合并。
- **上下文敏感展示**：每个页面底部的“告警中心”（`DedicatedAlarmZone`）只需对全局告警池按设备 ID 进行内存过滤即可。

---

## 4. 告警中心历史查询优化

在历史告警溯源业务中，为了提高操作效率并与系统整体风格保持一致，提出以下优化要求：

### 4.1 UI 风格对齐
- **风格同步**：告警中心的历史查询视图应完全对齐“数据查询页面”的交互模式（简洁的筛选栏 + 明确的“执行查询”按钮 + 结果列表）。
- **组件复用**：复用现有的分页组件与表格样式，确保视觉的一致性。

### 4.2 数据来源动态化
- **设备列表同步**：查询条件中的“设备下拉框”必须摒弃硬编码方式，改为通过 `EquipmentStore` 动态获取后端真实的设备列表，确保 8 个核心系统设备及未来扩展设备的一致性。

### 4.3 筛选逻辑简化
- **聚焦核心**：由于业务侧更关心特定设备在特定时间段的异常表现，决定**移除“告警状态”和“告警等级”**的筛选控制项。
- **降维打击**：通过简化筛选维度，引导操作员快速锁定故障设备及其对应的监测点数据。

### 4.4 高效分页查询
- **技术实现**：明确历史告警必须通过标准的 HTTP/REST 接口进行查询，严禁使用 WebSocket 推送全量历史数据。
- **分页要求**：查询结果必须具备分页功能，由后端返回总条数（Total）和当前页数据，前端仅负责视图渲染和翻页调度。

---

## 5. 结论

通过从“局部按需订阅”到“全局实时总线”的架构转型，系统可以消除 TopBar 指示器误报、Dashboard 数据冻结等核心痛点。这种设计更符合工业控制系统高可靠性、高连贯性的业务本质。
