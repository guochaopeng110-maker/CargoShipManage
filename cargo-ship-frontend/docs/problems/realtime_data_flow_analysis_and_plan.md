# 实时数据流与告警系统分析及优化方案

## 1. 问题背景与现状分析

在对“货船智能机舱管理系统”的实时数据链路进行深度排查后，发现目前系统在**实时监测数据展示**和**告警推送**方面存在核心矛盾，导致前端 UI 无法准确映射模拟器发出的实时数据。

### 1.1 核心矛盾：三方契约不一致
目前系统内存在三种不同的“语言”，导致数据流在传递过程中出现断层：

1.  **模拟器层 (Simulator)**：发送原始 ID，如 `monitoringPoint: "MP-BATT-001"`。
2.  **契约文档层 (Docs)**：要求使用标准中文名，如 `monitoringPoint: "总电压"`（参考 `monitoring_point_definition.md`）。
3.  **前端实现层 (Frontend)**：
    *   **Store 索引**：仅使用 `metricType` (如 `voltage`) 进行分类存储，无法区分同一设备下的多个同类型指标（如“环境温度”与“单体温度”）。
    *   **UI 配置**：使用英文 Key (如 `total_voltage`) 进行查找映射。

### 1.2 潜在风险
*   **数据跳变**：同一设备下的多个同类型指标会交替覆盖 Store 中的同一个 Key，造成 UI 数值剧烈跳变。
*   **配置错位**：UI 找不到对应的模拟数据，导致始终显示为 0 或“暂无数据”。
*   **告警信息遗漏**：告警推送的字段映射不全，导致实时告警中心无法显示设备详情。

---

## 2. 优化方案：建立基于“标准中文名”的统一契约

为了彻底解决数据链路的稳定性问题，建议将全链路的指标标识符统一为：**`设备ID + 标准中文监测点名称`**。

### 2.1 模拟器 (Simulator) 深度重构
*   **标准命名对齐**：修改 `realtime-simulator.js`，确保 `monitoringPoint` 字段严格按照文档输出中文名（如“SOC荷电状态”）。
*   **全系统覆盖**：对齐 8 个核心系统（电池、推进L/R、逆变器1/2、直流配电、舱底水、冷却水）的全部监测点。
*   **实时告警内建**：在模拟器中嵌入 `monitoring_and_alarm_definitions.md` 定义的阈值逻辑，真实模拟 `alarm:push` 事件。

### 2.2 状态管理 (Store) 逻辑优化
*   **索引 Key 修正**：修改 `monitoring-store.ts` 中的 `handleRealtimeData`，将存储 Key 由 `${equipmentId}-${metricType}` 更改为 **`${equipmentId}-${monitoringPoint}`**。
*   **告警映射增强**：在 `alarms-store.ts` 中增强 `mapPayloadToAlarm` 函数，确保 `equipmentName` 等关键字段在解析阶段被正确填充。

### 2.3 UI 配置库 (Icon Mapping) 修正
*   **Key 映射对齐**：修改 `icon-mapping.ts`，将所有配置 Key 更新为标准中文字符串（如 `SYS-BAT-001:总电压`）。
*   **确保语义一致性**：UI 查找逻辑与 Store 存储 Key 保持高度一致。

---

## 3. 驾控台 (Dashboard) 功能重构方案

根据业务需求，驾控台应从“具体指标展示”转型为“全局运行指挥中心”。

### 3.1 移除具体指标墙
*   移除 `CriticalMetricsWall` (关键指标墙)，首页不再直接显示具体的数值（如 650.5V），这些高频变动的数据留给后续的详细监控页面。

### 3.2 新增系统状态矩阵 (SystemsStatusGrid)
*   **展现形式**：展示 8 个核心系统的卡片阵列。
*   **核心指标**：
    *   **连接状态**：显示系统是否在线。
    *   **告警状态**：该系统当前是否存在未处理告警（变色提醒）。
    *   **运行开关量**：显示“运行/停止”或“合闸/分闸”状态（基于 bool 值）。
*   **交互逻辑**：点击卡片直达该系统的详情页面（如：点击“电池系统”卡片 -> 跳转至 `/monitoring/battery`）。

### 3.3 强化实时告警摘要
*   提升 `AlarmSummaryWidget` 的视觉优先级，确保最新的 `critical` 等级告警能够第一时间在首页滚动。

---

## 4. 实施路径图 (Roadmap)

1.  **Phase 1 (基础对齐)**：完成模拟器重构与 Store 索引逻辑修正。
2.  **Phase 2 (监控页修复)**：更新 5 个监控子页面的 `MonitoringWall` 配置，全部改为中文名匹配。
3.  **Phase 3 (驾控台改造)**：开发 `SystemStatusCard` 组件，重排首页布局。
4.  **Phase 4 (全链路验收)**：通过模拟器注入关键故障（如“总压欠压-三级”），验证首页报警变色、告警中心弹窗、详情页数值变红的联动效果。

---

**文档说明**：
*   **创建日期**：2025-12-22
*   **状态**：方案待评审/待实施
*   **关联文档**：`monitoring_point_definition.md`, `websocket-api.md`
